{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import libQ from 'kew';\nimport VConf from 'v-conf';\nimport JpRadio from './lib/radio';\nimport { BrowseResult } from './lib/models/BrowseResultModel';\n\nexport = ControllerJpRadio;\n\nclass ControllerJpRadio {\n  private context: any;\n  private commandRouter: any;\n  private logger: any;\n  private configManager: any;\n  private config: InstanceType<typeof VConf> | null = null;\n  private readonly serviceName = 'jp_radio';\n  private appRadio: JpRadio | null = null;\n\n  constructor(context: any) {\n    this.context = context;\n    this.commandRouter = context.coreCommand;\n    this.logger = context.logger;\n    this.configManager = context.configManager;\n  }\n\n  async restartPlugin(): Promise<void> {\n    try {\n      await this.onStop();\n      await this.onStart();\n    } catch {\n      this.commandRouter.pushToastMessage('error', 'Restart Failed', 'The plugin could not be restarted.');\n    }\n  }\n\n  private showRestartModal(): void {\n    const message = {\n      title: 'Plugin Restart Required',\n      message: 'Changes have been made that require the JP Radio plugin to be restarted. Please click the restart button below.',\n      size: 'lg',\n      buttons: [\n        {\n          name: this.commandRouter.getI18nString('COMMON.RESTART'),\n          class: 'btn btn-info',\n          emit: 'callMethod',\n          payload: {\n            endpoint: 'music_service/jp_radio',\n            method: 'restartPlugin',\n            data: {}\n          }\n        },\n        {\n          name: this.commandRouter.getI18nString('COMMON.CANCEL'),\n          class: 'btn btn-info',\n          emit: 'closeModals',\n          payload: ''\n        }\n      ]\n    };\n    this.commandRouter.broadcastMessage('openModal', message);\n  }\n\n  async saveServicePort(data: { servicePort: string }): Promise<void> {\n    const newPort = Number(data.servicePort);\n    if (!isNaN(newPort) && this.config && this.config.get('servicePort') !== newPort) {\n      this.config.set('servicePort', newPort);\n      this.showRestartModal();\n    }\n  }\n\n  async saveRadikoAccount(data: { radikoUser: string; radikoPass: string }): Promise<void> {\n    if (!this.config) return;\n    const updated = ['radikoUser', 'radikoPass'].some(\n      (key) => this.config!.get(key) !== (data as any)[key]\n    );\n    if (updated) {\n      this.config.set('radikoUser', data.radikoUser);\n      this.config.set('radikoPass', data.radikoPass);\n      this.showRestartModal();\n    }\n  }\n\n  onVolumioStart(): Promise<void> {\n    const defer = libQ.defer();\n    try {\n      const configFile = this.commandRouter.pluginManager.getConfigurationFile(this.context, 'config.json');\n      this.config = new VConf();\n      this.config.loadFile(configFile);\n      defer.resolve();\n    } catch (error) {\n      defer.reject(error);\n    }\n    return defer.promise;\n  }\n  \n  onStart(): Promise<void> {\n    const defer = libQ.defer();\n\n    if (!this.config) {\n      this.logger.error('Config not initialized onStart');\n      defer.reject(new Error('Config not initialized'));\n      return defer.promise;\n    }\n\n    const radikoUser = this.config.get('radikoUser');\n    const radikoPass = this.config.get('radikoPass');\n    const servicePort = this.config.get('servicePort') || 9000;\n    const account = radikoUser && radikoPass ? { mail: radikoUser, pass: radikoPass } : null;\n\n    this.appRadio = new JpRadio(servicePort, this.logger, account, this.commandRouter);\n\n    this.appRadio.start()\n      .then(() => {\n        this.addToBrowseSources();\n        defer.resolve();\n      })\n      .catch((err) => {\n        if (err.code === 'EADDRINUSE') {\n          const message = `ポート ${servicePort} はすでに使用中です。JP Radio を開始できません。`;\n          this.logger.error(`JP_Radio::ポート使用中エラー: ${message}`);\n          this.commandRouter.pushToastMessage('error', 'JP Radio 起動エラー', message);\n        } else {\n          this.logger.error('JP_Radio::Failed to start appRadio', err);\n          this.commandRouter.pushToastMessage('error', 'JP Radio 起動エラー', err.message || '不明なエラー');\n        }\n\n        defer.reject(err);\n      });\n\n    return defer.promise;\n  }\n\n  async onStop(): Promise<void> {\n    try {\n      if (this.appRadio) await this.appRadio.stop();\n    } catch (err) {\n      this.logger.error('JP_Radio::Error stopping appRadio', err);\n    }\n    this.commandRouter.volumioRemoveToBrowseSources('RADIKO');\n  }\n\n  getUIConfig(): Promise<any> {\n    const defer = libQ.defer();\n    const langCode = this.commandRouter.sharedVars.get('language_code') || 'en';\n\n    this.commandRouter.i18nJson(\n      `${__dirname}/i18n/strings_${langCode}.json`,\n      `${__dirname}/i18n/strings_en.json`,\n      `${__dirname}/UIConfig.json`\n    )\n    .then((uiconf: any) => {\n      const servicePort = this.config.get('servicePort');\n      const radikoUser = this.config.get('radikoUser');\n      const radikoPass = this.config.get('radikoPass');\n\n      if (uiconf.sections?.[0]?.content?.[0]) uiconf.sections[0].content[0].value = servicePort;\n      if (uiconf.sections?.[1]?.content?.[0]) uiconf.sections[1].content[0].value = radikoUser;\n      if (uiconf.sections?.[1]?.content?.[1]) uiconf.sections[1].content[1].value = radikoPass;\n\n      defer.resolve(uiconf);\n    })\n    .catch((error: any) => {\n      this.logger.error('getUIConfig failed:', error);\n      defer.reject(error);\n    });\n\n    return defer.promise;\n  }\n\n  \n  getConfigurationFiles(): string[] {\n    return ['config.json'];\n  }\n\n  addToBrowseSources(): void {\n    this.commandRouter.volumioAddToBrowseSources({\n      name: 'RADIKO',\n      uri: 'radiko',\n      plugin_type: 'music_service',\n      plugin_name: this.serviceName,\n      albumart: '/albumart?sourceicon=music_service/jp_radio/assets/images/app_radiko.svg'\n    });\n  }\n\n  async handleBrowseUri(curUri: string): Promise<BrowseResult | {}> {\n    const [baseUri] = curUri.split('?');\n\n    if (baseUri === 'radiko') {\n      if (!this.appRadio) {\n        return {};\n      }\n      return await this.appRadio.radioStations();\n    }\n\n    return {};\n  }\n\n  clearAddPlayTrack(track: any): Promise<any> {\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::clearAddPlayTrack`, track);\n    return libQ.resolve();\n  }\n\n  seek(timepos: number): Promise<any> {\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::seek to ${timepos}`);\n    return libQ.resolve();\n  }\n\n  stop(): void {\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::stop`);\n  }\n\n  pause(): void {\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::pause`);\n  }\n\n  getState(): void {\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::getState`);\n  }\n\n  parseState(sState: any): void {\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::parseState`);\n  }\n\n  pushState(state: any): any {\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::pushState`);\n    return this.commandRouter.servicePushState(state, this.serviceName);\n  }\n\n  explodeUri(uri: string): Promise<any> {\n    return libQ.resolve();\n  }\n\n  search(query: any): Promise<any> {\n    return libQ.resolve();\n  }\n\n  goto(data: any): Promise<any> {\n    return libQ.resolve();\n  }\n}\n"]}