{"version":3,"file":"FeedModel.js","sourceRoot":"","sources":["../../../src/lib/model/FeedModel.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,4DAA4F;AAC5F,uDAAoF;AACpF,sDAA8B;AAI9B,sEAA8C;AAa9C,MAAqB,SAAU,SAAQ,mBAAS;IAAhD;;;IAqDA,CAAC;IAnDC,YAAY,CAAC,MAAmC;QAC9C,MAAM,QAAQ,GAAG,CAAA,IAAI,CAAC,2CAAqD,CAAA,CAAC;QAC5E,MAAM,gBAAgB,GAAG,CAAA,IAAI,CAAC,yCAAmD,CAAA,CAAC;QAElF,OAAO,IAAI,CAAC,SAAS,CAAC;YACpB,cAAc,EAAE,EAAE,GAAG,MAAM,EAAE;YAC7B,eAAe,EAAE,uBAAA,IAAI,iEAA0B,CAAC,IAAI,CAAC,IAAI,CAAC;YAC1D,uBAAuB,EAAE,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC;YAC5C,+BAA+B,EAAE,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC;YAC5D,eAAe,EAAE,uBAAA,IAAI,uEAAgC,CAAC,IAAI,CAAC,IAAI,CAAC;YAChE,KAAK,EAAE,uBAAA,IAAI,mEAA4B,CAAC,IAAI,CAAC,IAAI,CAAC;YAClD,SAAS,EAAE,MAAM,CAAC,SAAS;YAC3B,UAAU,EAAE,MAAM,CAAC,UAAU;YAC7B,KAAK,EAAE,MAAM,CAAC,KAAK;SACpB,CAAC,CAAC;IACL,CAAC;CAoCF;4EAlCC,KAAK,8CAA2B,MAA2C;IACzE,MAAM,GAAG,GAAG,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAEpC,MAAM,oBAAoB,GAAG,MAAM,IAAI,CAAC,mCAAmC,CAAW,MAAM,CAAC,CAAC;IAC9F,IAAI,oBAAoB,EAAE,CAAC;QACzB,OAAO,oBAAoB,CAAC;IAC9B,CAAC;IAED,MAAM,WAAW,GAAG;QAClB,aAAa,EAAE,MAAM,CAAC,aAAa;QACnC,KAAK,EAAE,4BAAS,CAAC,eAAe;KACjC,CAAC;IACF,OAAO,GAAG,CAAC,EAAE,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;AACrC,CAAC,8CAED,KAAK,oDAAiC,IAAc;IAClD,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC;IAC9B,IAAI,WAAW,YAAY,wBAAK,EAAE,CAAC;QACjC,OAAO,gBAAM,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC;IACtC,CAAC;SACI,IAAI,WAAW,YAAY,2BAAQ,EAAE,CAAC;QACzC,OAAO,gBAAM,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;IACzC,CAAC;SACI,IAAI,WAAW,YAAY,wBAAK,EAAE,CAAC;QACtC,OAAO,gBAAM,CAAC,QAAQ,CAAC,WAAW,CAAC,CAAC;IACtC,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC,yFAE2B,MAAmE;IAC7F,MAAM,MAAM,GAAG,MAAM,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,OAAO,CAAC,CAAC;IACpE,qBAAW,CAAC,WAAW,CAAC,MAAM,EAAE,IAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC,CAAC;IAC9E,OAAO,MAAM,CAAC;AAChB,CAAC;kBApDkB,SAAS","sourcesContent":["import BaseModel, { type LoopFetchCallbackParams, type LoopFetchResult } from './BaseModel';\nimport { Album, Constants, type FeedItem, Playlist, Track } from 'soundcloud-fetch';\nimport Mapper from './Mapper';\nimport type PlaylistEntity from '../entities/PlaylistEntity';\nimport type AlbumEntity from '../entities/AlbumEntity';\nimport type TrackEntity from '../entities/TrackEntity';\nimport TrackHelper from '../util/TrackHelper';\n\nexport interface FeedModelGetFeedItemsParams {\n  pageToken?: string;\n  pageOffset?: number;\n  limit?: number;\n  activityTypes: ['TrackPost', 'TrackRepost'];\n}\n\ninterface GetFeedItemsLoopFetchCallbackParams extends LoopFetchCallbackParams {\n  activityTypes: ['TrackPost', 'TrackRepost'];\n}\n\nexport default class FeedModel extends BaseModel {\n\n  getFeedItems(params: FeedModelGetFeedItemsParams) {\n    const getItems = this.commonGetCollectionItemsFromLoopFetchResult<FeedItem>;\n    const getNextPageToken = this.commonGetNextPageTokenFromLoopFetchResult<FeedItem>;\n\n    return this.loopFetch({\n      callbackParams: { ...params },\n      getFetchPromise: this.#getFeedItemsFetchPromise.bind(this),\n      getItemsFromFetchResult: getItems.bind(this),\n      getNextPageTokenFromFetchResult: getNextPageToken.bind(this),\n      convertToEntity: this.#convertFetchedFeedItemToEntity.bind(this),\n      onEnd: this.#onGetFeedItemsLoopFetchEnd.bind(this),\n      pageToken: params.pageToken,\n      pageOffset: params.pageOffset,\n      limit: params.limit\n    });\n  }\n\n  async #getFeedItemsFetchPromise(params: GetFeedItemsLoopFetchCallbackParams) {\n    const api = this.getSoundCloudAPI();\n\n    const continuationContents = await this.commonGetLoopFetchResultByPageToken<FeedItem>(params);\n    if (continuationContents) {\n      return continuationContents;\n    }\n\n    const queryParams = {\n      activityTypes: params.activityTypes,\n      limit: Constants.QUERY_MAX_LIMIT\n    };\n    return api.me.getFeed(queryParams);\n  }\n\n  async #convertFetchedFeedItemToEntity(item: FeedItem): Promise<AlbumEntity | PlaylistEntity | TrackEntity | null> {\n    const wrappedItem = item.item;\n    if (wrappedItem instanceof Album) {\n      return Mapper.mapAlbum(wrappedItem);\n    }\n    else if (wrappedItem instanceof Playlist) {\n      return Mapper.mapPlaylist(wrappedItem);\n    }\n    else if (wrappedItem instanceof Track) {\n      return Mapper.mapTrack(wrappedItem);\n    }\n    return null;\n  }\n\n  #onGetFeedItemsLoopFetchEnd(result: LoopFetchResult<AlbumEntity | PlaylistEntity | TrackEntity>) {\n    const tracks = result.items.filter((item) => item.type === 'track');\n    TrackHelper.cacheTracks(tracks, this.getCacheKeyForFetch.bind(this, 'track'));\n    return result;\n  }\n}\n"]}