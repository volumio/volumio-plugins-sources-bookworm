{"version":3,"file":"ExternalPlayers.js","sourceRoot":"","sources":["../../../../src/lib/controller/play/ExternalPlayers.ts"],"names":[],"mappings":"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","sourcesContent":["import sc from '../../SoundCloudContext';\nimport { MPVService, VLCService } from 'volumio-ext-players';\n\nexport type ExternalPlayer = 'vlc' | 'mpv';\n\ntype PlayerMap = Record<ExternalPlayer, MPVService | VLCService | null>;\n\nasync function startMpv() {\n  sc.toast('info', sc.getI18n('SOUNDCLOUD_STARTING_PLAYER', 'mpv'));\n  try {\n    const mpv = new MPVService({\n      serviceName: 'soundcloud',\n      logger: sc.getLogger(),\n      volumio: {\n        commandRouter: sc.volumioCoreCommand,\n        mpdPlugin: sc.getMpdPlugin(),\n        statemachine: sc.getStateMachine()\n      },\n      mpvArgs: [\n        '--force-seekable=yes',\n        '--demuxer=lavf',\n        '--demuxer-lavf-o=extension_picky=0,allowed_extensions=ALL,allowed_segment_extensions=ALL'\n      ]\n    });\n    await mpv.start();\n    return mpv;\n  }\n  catch (error) {\n   throw Error(sc.getErrorMessage(sc.getI18n('SOUNDCLOUD_ERR_PLAYER_START', 'mpv'), error));\n  }\n}\n\nasync function startVLC() {\n  sc.toast('info', sc.getI18n('SOUNDCLOUD_STARTING_PLAYER', 'VLC'));\n  try {\n    const vlc = new VLCService({\n      serviceName: 'soundcloud',\n      logger: sc.getLogger(),\n      volumio: {\n        commandRouter: sc.volumioCoreCommand,\n        mpdPlugin: sc.getMpdPlugin(),\n        statemachine: sc.getStateMachine()\n      }\n    });\n    await vlc.start();\n    return vlc;\n  }\n  catch (error) {\n    throw Error(sc.getErrorMessage(sc.getI18n('SOUNDCLOUD_ERR_PLAYER_START', 'VLC'), error));\n  }\n}\n\nexport class ExternalPlayers {\n  static #players: PlayerMap = {\n    vlc: null,\n    mpv: null\n  };\n\n  static async get(player: ExternalPlayer) {\n    if (this.#players[player]) {\n      return this.#players[player];\n    }\n    let startPromise;\n    switch (player) {\n      case 'mpv':\n        startPromise = startMpv();\n        break;\n      case 'vlc':\n        startPromise = startVLC();\n        break;\n    }\n    sc.getLogger().info(`[soundcloud] Going to start ${player} for playback`);\n    const playerName = this.#getPlayerName(player);\n    try {\n      const p = await startPromise;\n      p.once('close', (code) => {\n        if (code && code !== 0) {\n          sc.toast('warning', sc.getI18n('SOUNDCLOUD_PLAYER_CLOSED_UNEXPECTEDLY', playerName))\n        }\n        sc.getLogger().info(`[soundcloud] ${player} process closed`);\n        this.#players[player] = null;\n      });\n      this.#players[player] = p;\n      return p;\n    }\n    catch (error) {\n      sc.toast('error', sc.getErrorMessage(sc.getI18n('SOUNDCLOUD_ERR_PLAYER_START', playerName), error));\n      return null;\n    }\n  }\n\n  static stop(player: ExternalPlayer) {\n    const p = this.#players[player];\n    if (p && p.isActive()) {\n      return p.stop();\n    }\n  }\n\n  static getActive() {\n    return Object.values(this.#players).find((p) => p && p.isActive()) ?? null;\n  }\n\n  static async quit(player: ExternalPlayer) {\n    const p = this.#players[player];\n    if (p) {\n      try {\n        await p.quit();\n      }\n      catch (error) {\n        sc.toast('error', sc.getI18n('SOUNDCLOUD_ERR_PLAYER_QUIT', this.#getPlayerName(player), sc.getErrorMessage('', error, false)));\n      }\n      finally {\n        this.#players[player] = null;\n      }\n    }\n  }\n\n  static quitAll() {\n    return Promise.all(Object.keys(this.#players).map((player) => this.quit(player as ExternalPlayer)));\n  }\n\n  static #getPlayerName(player: ExternalPlayer) {\n    switch (player) {\n      case 'mpv':\n        return 'mpv';\n      case 'vlc':\n        return 'VLC';\n    }\n  }\n}"]}