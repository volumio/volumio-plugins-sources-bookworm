{"version":3,"file":"PlayController.js","sourceRoot":"","sources":["../../../../src/lib/controller/play/PlayController.ts"],"names":[],"mappings":"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","sourcesContent":["// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport libQ from 'kew';\n\nimport sc from '../../SoundCloudContext';\nimport Model, { ModelType } from '../../model';\nimport { jsPromiseToKew, kewToJSPromise } from '../../util/Misc';\nimport TrackHelper from '../../util/TrackHelper';\nimport { type QueueItem } from '../browse/view-handlers/ExplodableViewHandler';\nimport ViewHelper from '../browse/view-handlers/ViewHelper';\nimport { type PlaylistView } from '../browse/view-handlers/PlaylistViewHandler';\nimport { type AlbumView } from '../browse/view-handlers/AlbumViewHandler';\nimport { type UserView } from '../browse/view-handlers/UserViewHandler';\nimport { type TrackView } from '../browse/view-handlers/TrackViewHandler';\nimport { ExternalPlayers } from './ExternalPlayers';\n\nexport default class PlayController {\n\n  #mpdPlugin: any;\n\n  constructor() {\n    this.#mpdPlugin = sc.getMpdPlugin();\n  }\n\n  /**\n   * Track uri:\n   * soundcloud/track@trackId=...\n   */\n  async clearAddPlayTrack(track: QueueItem) {\n    sc.getLogger().info(`[soundcloud] clearAddPlayTrack: ${track.uri}`);\n\n    const trackView = ViewHelper.getViewsFromUri(track.uri).pop() as TrackView | undefined;\n    if (!trackView || trackView.name !== 'track' || !trackView.trackId) {\n      throw Error(`Invalid track uri: ${track.uri}`);\n    }\n\n    const { trackId, origin } = trackView;\n    const model = Model.getInstance(ModelType.Track);\n\n    const trackData = await model.getTrack(Number(trackId));\n    if (!trackData) {\n      throw Error(`Failed to fetch track: ${track.uri}`);\n    }\n\n    if (trackData.playableState === 'blocked') {\n      sc.toast('warning', sc.getI18n('SOUNDCLOUD_SKIP_BLOCKED_TRACK', track.title));\n      sc.getStateMachine().next();\n      return;\n    }\n    else if (trackData.playableState === 'snipped' && sc.getConfigValue('skipPreviewTracks')) {\n      sc.toast('warning', sc.getI18n('SOUNDCLOUD_SKIP_PREVIEW_TRACK', track.title));\n      sc.getStateMachine().next();\n      return;\n    }\n\n    const { transcodingUrl, codec, bitrate } = TrackHelper.getPreferredStream(trackData) || {};\n    if (!transcodingUrl) {\n      throw Error('No transcoding found');\n    }\n\n    let streamingUrl = await model.getStreamingUrl(transcodingUrl, trackData.trackAuthorization || undefined);\n    if (!streamingUrl) {\n      throw Error('No stream found');\n    }\n\n    /**\n     * Choose suitable player - VLC or mpv:\n     * \n     * | Format     | VLC               | mpv                  |\n     * |------------|-------------------|----------------------|\n     * | Opus HLS   | Fails             | Plays + seek         |\n     * | AAC HLS    | Plays + seek      | Plays; seek fails    |\n     * | MP3 HLS    | Plays; seek fails | Plays; seek fails    |\n     * | MP3 HTTP   | Plays + seek      | Plays + seek         |\n     */\n\n    const target = {\n      ...track,\n      streamUrl: streamingUrl,\n      trackType: codec,\n      samplerate: bitrate\n    };\n    // Use VLC for AAC streams; mpv for others.\n    const playerName = codec === 'aac' ? 'vlc' : 'mpv';\n\n    // If the other player is active, stop it first to free up audio device.\n    if (playerName === 'vlc') {\n      await ExternalPlayers.stop('mpv');\n    }\n    else if (playerName === 'mpv') {\n      await ExternalPlayers.stop('vlc');\n    }\n\n    const player = await ExternalPlayers.get(playerName);\n\n    if (player) {\n      await player.play(target);\n    }\n    else {\n      /**\n       * Fallback to mpd if player failed to start\n       * 1. Add bitrate info to track\n       * 2. Fool MPD plugin to return correct `trackType` in `parseTrackInfo()` by adding\n       * track type to URL query string as a dummy param.\n       */\n      track.samplerate = bitrate;\n      streamingUrl += `&_vt=.${codec}`;\n\n      const safeUri = streamingUrl.replace(/\"/g, '\\\\\"');\n      // Play with MPD\n      await this.#playWithMpd(safeUri, track);\n    }\n\n    if (sc.getConfigValue('addPlayedToHistory')) {\n      await Model.getInstance(ModelType.Me).addToPlayHistory(trackData, origin);\n    }\n  }\n\n  #playWithMpd(streamUrl: string, track: QueueItem) {\n    const mpdPlugin = this.#mpdPlugin;\n\n    return kewToJSPromise(mpdPlugin.sendMpdCommand('stop', [])\n      .then(() => {\n        return mpdPlugin.sendMpdCommand('clear', []);\n      })\n      .then(() => {\n        return mpdPlugin.sendMpdCommand(`addid \"${streamUrl}\"`, []);\n      })\n      .then((addIdResp: { Id: string }) => this.#mpdAddTags(addIdResp, track))\n      .then(() => {\n        sc.getStateMachine().setConsumeUpdateService('mpd', true, false);\n        return mpdPlugin.sendMpdCommand('play', []);\n      }));\n  }\n\n  // Returns kew promise!\n  #mpdAddTags(mpdAddIdResponse: { Id: string }, track: QueueItem) {\n    const songId = mpdAddIdResponse?.Id;\n    if (songId !== undefined) {\n      const cmds = [];\n      cmds.push({\n        command: 'addtagid',\n        parameters: [ songId, 'title', this.#stripNewLine(track.title) ]\n      });\n      if (track.album) {\n        cmds.push({\n          command: 'addtagid',\n          parameters: [ songId, 'album', this.#stripNewLine(track.album) ]\n        });\n      }\n      if (track.artist) {\n        cmds.push({\n          command: 'addtagid',\n          parameters: [ songId, 'artist', this.#stripNewLine(track.artist) ]\n        });\n      }\n\n      return this.#mpdPlugin.sendMpdCommandArray(cmds);\n    }\n    return libQ.resolve();\n  }\n\n  // Returns kew promise!\n  stop() {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      return jsPromiseToKew(player.stop());\n    }\n    sc.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.stop();\n  }\n\n  // Returns kew promise!\n  pause() {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      return jsPromiseToKew(player.pause());\n    }\n    sc.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.pause();\n  }\n\n  // Returns kew promise!\n  resume() {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      return jsPromiseToKew(player.resume());\n    }\n    sc.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.resume();\n  }\n\n  play() {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      return jsPromiseToKew((async () => {\n        if (player.getStatus()?.state === 'paused') {\n          return player.resume();\n        }\n      })());\n    }\n    sc.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.play();\n  }\n\n  // Returns kew promise!\n  seek(position: number) {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      return jsPromiseToKew(player.seek(position / 1000));\n    }\n    sc.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.seek(position);\n  }\n\n  // Returns kew promise!\n  next() {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      return jsPromiseToKew(player.next());\n    }\n    sc.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.next();\n  }\n\n  // Returns kew promise!\n  previous() {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      return jsPromiseToKew(player.previous());\n    }\n    sc.getStateMachine().setConsumeUpdateService(undefined);\n    return sc.getStateMachine().previous();\n  }\n\n  setRandom(value: boolean) {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      player.setRandom(value);\n    }\n  }\n\n  setRepeat(value: boolean, repeatSingle: boolean) {\n    const player = ExternalPlayers.getActive();\n    if (player) {\n      return jsPromiseToKew(player.setRepeat(value, repeatSingle));\n    }\n  }\n\n  #stripNewLine(str: string) {\n    return str.replace(/(\\r\\n|\\n|\\r)/gm, '');\n  }\n\n  async getGotoUri(type: 'album' | 'artist', uri: QueueItem['uri']): Promise<string | null> {\n    const trackView = ViewHelper.getViewsFromUri(uri).pop() as TrackView | undefined;\n    if (trackView && trackView.name === 'track' && trackView.trackId && (type === 'album' || type === 'artist')) {\n      if (type === 'album' && trackView.origin) {\n        const origin = trackView.origin;\n        if (origin.type === 'album') {\n          const albumView: AlbumView = {\n            name: 'albums',\n            albumId: origin.albumId.toString()\n          };\n          return `soundcloud/${ViewHelper.constructUriSegmentFromView(albumView)}`;\n        }\n        else if (origin.type === 'playlist' || origin.type === 'system-playlist') {\n          const playlistView: PlaylistView = {\n            name: 'playlists',\n            playlistId: origin.playlistId.toString()\n          };\n          if (origin.type === 'system-playlist') {\n            playlistView.type = 'system';\n          }\n          return `soundcloud/${ViewHelper.constructUriSegmentFromView(playlistView)}`;\n        }\n      }\n      const track = await Model.getInstance(ModelType.Track).getTrack(Number(trackView.trackId));\n      if (track && track.user?.id !== undefined) {\n        const userView: UserView = {\n          name: 'users',\n          userId: track.user.id.toString()\n        };\n        return `soundcloud/${ViewHelper.constructUriSegmentFromView(userView)}`;\n      }\n\n    }\n    return 'soundcloud';\n  }\n\n  async reset() {\n    await ExternalPlayers.quitAll();\n  }\n}\n"]}