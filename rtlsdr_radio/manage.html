<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Station Management - RTL-SDR Radio</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #1c1c1c;
      color: #e0e0e0;
      padding: 0;
      margin: 0;
    }
    
    .header {
      background: #282828;
      border-bottom: 1px solid #404040;
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-content {
      flex: 1;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 500;
      color: #fff;
      margin-bottom: 5px;
    }
    
    .header .subtitle {
      font-size: 13px;
      color: #999;
    }
    
    .header-close-btn {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      margin-left: 20px;
      white-space: nowrap;
    }
    
    .header-close-btn:hover {
      background: #b71c1c;
    }
    
    .header-close-btn:active {
      background: #8b0000;
    }
    
    .header-close-btn.hidden {
      display: none;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 1px solid #404040;
    }
    
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 15px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab:hover {
      color: #fff;
    }
    
    .tab.active {
      color: #54b948;
      border-bottom-color: #54b948;
    }
    
    .tab .fa {
      font-size: 14px;
    }
    
    .tab-badge {
      background: #e74c3c;
      color: #fff;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      min-width: 18px;
      text-align: center;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .tab-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .search-bar {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    
    .search-bar input {
      width: 100%;
      padding: 12px 40px 12px 15px;
      background: #282828;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #e0e0e0;
      font-size: 14px;
    }
    
    .search-bar input:focus {
      outline: none;
      border-color: #54b948;
    }
    
    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
    }
    
    .save-status-inline {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #999;
      font-size: 13px;
      padding: 0 10px;
    }
    
    .save-status-inline.changed {
      color: #e67e22;
    }
    
    .save-status-inline .fa {
      font-size: 14px;
    }
    
    .station-list {
      background: #282828;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .station-item {
      padding: 15px;
      border-bottom: 1px solid #404040;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: background 0.2s;
    }
    
    .station-item:last-child {
      border-bottom: none;
    }
    
    .station-item:hover {
      background: #333;
    }
    
    .station-item.deleted {
      opacity: 0.6;
    }
    
    .station-icon {
      width: 40px;
      text-align: center;
      font-size: 18px;
      flex-shrink: 0;
      color: #666;
    }
    
    .station-icon.favorite {
      color: #f39c12;
    }
    
    .station-icon.hidden-icon {
      color: #e74c3c;
    }
    
    .signal-indicator {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-left: auto;
      padding-right: 10px;
    }
    
    .signal-indicator .fa-signal {
      font-size: 14px;
    }
    
    .signal-indicator.signal-0 .fa-signal { color: #666; }
    .signal-indicator.signal-1 .fa-signal { color: #e74c3c; }
    .signal-indicator.signal-2 .fa-signal { color: #e67e22; }
    .signal-indicator.signal-3 .fa-signal { color: #f1c40f; }
    .signal-indicator.signal-4 .fa-signal { color: #2ecc71; }
    .signal-indicator.signal-5 .fa-signal { color: #27ae60; }
    
    .signal-indicator .signal-text {
      font-size: 11px;
      color: #999;
      min-width: 28px;
    }
    
    .station-item.now-playing {
      background: #2a3a2a;
      border-left: 3px solid #2ecc71;
    }
    
    .station-info {
      flex: 1;
      min-width: 0;
    }
    
    .station-name {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #fff;
    }
    
    .station-details {
      font-size: 12px;
      color: #999;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .station-type-badge {
      display: inline-block;
      background: #404040;
      color: #999;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .station-name-input {
      width: 100%;
      padding: 8px 10px;
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 3px;
      color: #e0e0e0;
      font-size: 14px;
      font-family: inherit;
    }
    
    .station-name-input:focus {
      outline: none;
      border-color: #54b948;
    }
    
    .frequency-input {
      width: 80px;
      padding: 4px 8px;
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 3px;
      color: #e0e0e0;
      font-size: 12px;
      font-family: 'Courier New', monospace;
      text-align: center;
    }
    
    .frequency-input:focus {
      outline: none;
      border-color: #54b948;
    }
    
    .frequency-input.error {
      border-color: #e74c3c;
    }
    
    .frequency-display {
      font-family: 'Courier New', monospace;
      color: #999;
    }
    
    .station-actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }
    
    .btn.btn-save-row {
      display: none;
      background: #27ae60;
      color: #fff;
      animation: fadeIn 0.2s;
    }
    
    .btn.btn-save-row:hover {
      background: #229954;
    }
    
    .station-item.dirty .btn.btn-save-row {
      display: inline-flex;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }
    
    .btn .fa {
      font-size: 13px;
    }
    
    .btn-icon {
      padding: 8px 12px;
      background: transparent;
      border: 1px solid #404040;
      color: #999;
    }
    
    .btn-icon:hover {
      background: #333;
      border-color: #54b948;
      color: #54b948;
    }
    
    .btn-icon.active {
      background: #54b948;
      border-color: #54b948;
      color: #fff;
    }
    
    .btn-icon.active.favorite {
      background: #f39c12;
      border-color: #f39c12;
    }
    
    .btn-icon.active.hidden {
      background: #e74c3c;
      border-color: #e74c3c;
    }
    
    .btn-danger {
      background: #e74c3c;
      color: #fff;
      border: 1px solid #e74c3c;
    }
    
    .btn-danger:hover {
      background: #c0392b;
      border-color: #c0392b;
    }
    
    .btn-warning {
      background: transparent;
      color: #f39c12;
      border: 1px solid #f39c12;
    }
    
    .btn-warning:hover {
      background: #f39c12;
      color: #fff;
    }
    
    .btn-primary {
      background: #54b948;
      color: #fff;
      border: 1px solid #54b948;
      font-weight: 500;
    }
    
    .btn-primary:hover {
      background: #449a39;
      border-color: #449a39;
    }
    
    .btn-primary:disabled {
      background: #333;
      border-color: #404040;
      color: #666;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #666;
      color: #fff;
      border: 1px solid #666;
    }
    
    .btn-secondary:hover {
      background: #555;
      border-color: #555;
    }
    
    .save-bar {
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: #282828;
      border-top: 1px solid #404040;
      padding: 15px 20px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      margin-top: 20px;
    }
    
    .save-bar .info {
      color: #999;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .save-bar .info .fa {
      font-size: 14px;
    }
    
    .save-bar .info.changed {
      color: #f39c12;
      font-weight: 500;
    }
    
    .save-bar .actions {
      display: flex;
      gap: 10px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state .fa {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .empty-state-text {
      font-size: 16px;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .stat-card {
      background: #282828;
      padding: 15px 20px;
      border-radius: 4px;
      flex: 1;
      min-width: 150px;
      border: 1px solid #404040;
    }
    
    .stat-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .stat-label .fa {
      font-size: 11px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 500;
      color: #54b948;
    }
    
    .toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: #54b948;
      color: #fff;
      padding: 15px 20px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 200;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s;
      max-width: 300px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .toast .fa {
      font-size: 16px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast.error {
      background: #e74c3c;
    }
    
    .toast.warning {
      background: #f39c12;
    }
    
    .recycle-notice {
      background: #404040;
      border-left: 3px solid #f39c12;
      padding: 12px 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      font-size: 13px;
      color: #e0e0e0;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    
    .recycle-notice .fa {
      color: #f39c12;
      margin-top: 2px;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
    }
    
    .modal-overlay.show {
      display: flex;
    }
    
    .modal {
      background: #282828;
      border-radius: 4px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #404040;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .modal-header.warning {
      background: #f39c12;
      color: #fff;
      border-bottom-color: #e08e0b;
    }
    
    .modal-header .fa {
      font-size: 24px;
    }
    
    .modal-header h2 {
      font-size: 18px;
      font-weight: 500;
      margin: 0;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-body p {
      margin-bottom: 15px;
      line-height: 1.5;
    }
    
    .freq-comparison {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
      padding: 15px;
      background: #1c1c1c;
      border-radius: 4px;
    }
    
    .freq-old, .freq-new {
      text-align: center;
    }
    
    .freq-old label, .freq-new label {
      display: block;
      font-size: 11px;
      color: #999;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    
    .freq-old span, .freq-new span {
      display: block;
      font-size: 20px;
      font-weight: 500;
      font-family: 'Courier New', monospace;
    }
    
    .freq-old span {
      color: #e74c3c;
    }
    
    .freq-new span {
      color: #54b948;
    }
    
    .freq-arrow {
      color: #666;
      font-size: 20px;
    }
    
    .warning-text {
      background: #404040;
      padding: 12px;
      border-radius: 4px;
      border-left: 3px solid #f39c12;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .modal-header.info {
      background: #3498db;
      color: #fff;
      border-bottom-color: #2980b9;
    }
    
    .modal-header.danger {
      background: #e74c3c;
      color: #fff;
      border-bottom-color: #c0392b;
    }
    
    .modal-header.success {
      background: #54b948;
      color: #fff;
      border-bottom-color: #459a3c;
    }
    
    .spinner-container {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #404040;
      border-top-color: #54b948;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .elapsed-time {
      text-align: center;
      font-size: 14px;
      color: #999;
      margin-top: 15px;
    }
    
    .elapsed-time .time-value {
      color: #54b948;
      font-weight: 500;
      font-family: 'Courier New', monospace;
    }
    
    .scanning-info {
      text-align: center;
      font-size: 13px;
      color: #999;
      margin-top: 10px;
    }
    
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #404040;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    #backup-history-body td {
      padding: 10px;
      border-top: 1px solid #404040;
      color: #e0e0e0;
      font-size: 13px;
    }
    
    #backup-history-body tr:hover {
      background: #333;
    }
    
    .backup-section {
      background: #282828;
      padding: 20px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .backup-section h3 {
      color: #999;
      font-size: 12px;
      margin: 0 0 15px 0;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .station-list h3 {
      color: #999;
      font-size: 12px;
      margin: 0;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .backup-form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .backup-form-row label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      color: #e0e0e0;
      font-size: 13px;
    }
    
    .backup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 15px;
    }
    
    .backup-grid-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }
    
    .backup-table-header {
      text-align: left;
      padding: 10px;
      color: #999;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        padding-bottom: 20px;
      }
      
      .station-item {
        flex-wrap: wrap;
      }
      
      .station-info {
        flex: 1 1 100%;
        margin-bottom: 10px;
      }
      
      .station-actions {
        flex: 1 1 100%;
        justify-content: flex-start;
      }
      
      .btn {
        flex: 1;
        min-width: 70px;
        justify-content: center;
      }
      
      .save-bar {
        flex-direction: column;
        gap: 10px;
        padding: 12px 15px;
      }
      
      .save-bar .actions {
        width: 100%;
      }
      
      .save-bar .actions button {
        flex: 1;
      }
      
      .stats {
        flex-direction: column;
        gap: 10px;
      }
      
      .stat-card {
        min-width: auto;
      }
      
      .toast {
        right: 15px;
        left: 15px;
        max-width: none;
      }
      
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .tab {
        flex-shrink: 0;
      }
      
      .modal {
        width: 95%;
      }
      
      .freq-comparison {
        flex-direction: column;
        gap: 10px;
      }
      
      .freq-arrow {
        transform: rotate(90deg);
      }
      
      #maintenance-tab [style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      
      .backup-grid {
        grid-template-columns: 1fr;
      }
      
    }
    
    /* Additional maintenance section utility classes */
    .flex-1 {
      flex: 1;
    }
    
    .maintenance-header {
      color: #54b948;
      font-size: 18px;
      margin: 0;
    }
    
    .tab-header-no-margin {
      margin: 0;
    }
    
    /* CSV Import/Export Section */
    .csv-section-header {
      color: #54b948;
      font-size: 16px;
      margin: 25px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #404040;
    }
    
    .csv-section-header:first-of-type {
      margin-top: 0;
    }
    
    .csv-operation-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .csv-operation-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 10px;
      background: #333;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .csv-operation-item:hover {
      background: #3a3a3a;
    }
    
    .csv-operation-item input[type="radio"] {
      margin-top: 3px;
    }
    
    .csv-operation-label {
      font-size: 13px;
      color: #e0e0e0;
    }
    
    .csv-operation-desc {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }
    
    #csv-validation-results {
      display: none;
      background: #333;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
    }
    
    #csv-validation-results.visible {
      display: block;
    }
    
    #csv-validation-results.has-errors {
      border-left: 3px solid #e74c3c;
    }
    
    #csv-validation-results.valid {
      border-left: 3px solid #54b948;
    }
    
    .csv-error-list {
      margin: 10px 0 0 0;
      padding-left: 20px;
      color: #e74c3c;
      font-size: 12px;
    }
    
    .csv-error-list li {
      margin: 5px 0;
    }
    
    @media (max-width: 768px) {
      .csv-operation-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .restore-label {
      display: block;
      margin-bottom: 5px;
      color: #999;
      font-size: 13px;
    }
    
    .restore-select {
      width: 100%;
      padding: 8px;
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #e0e0e0;
    }
    
    .file-input-hidden {
      display: none;
    }
    
    .upload-filename {
      color: #999;
      flex: 1;
    }
    
    .history-header {
      padding: 15px;
      border-bottom: 1px solid #404040;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table-header-row {
      background: #1c1c1c;
    }
    
    /* Artwork Block List */
    .blocklist-textarea-container {
      margin-bottom: 10px;
    }
    
    .blocklist-textarea {
      width: 100%;
      padding: 12px;
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #e0e0e0;
      font-family: inherit;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      min-height: 200px;
    }
    
    .blocklist-textarea:focus {
      outline: none;
      border-color: #54b948;
    }
    
    .blocklist-textarea::placeholder {
      color: #666;
    }
    
    .blocklist-stats {
      color: #999;
      font-size: 13px;
    }
    
    /* Antenna alignment tools */
    .antenna-info-box {
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #999;
    }
    
    .antenna-info-box i {
      color: #54b948;
      font-size: 18px;
    }
    
    .antenna-tool-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #404040;
    }
    
    .antenna-tool-section:last-of-type {
      border-bottom: none;
    }
    
    .antenna-tool-section h4 {
      color: #54b948;
      margin-bottom: 15px;
    }
    
    .antenna-tool-box {
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .antenna-tool-box p {
      margin: 8px 0;
      color: #ccc;
    }
    
    .antenna-tool-box strong {
      color: #54b948;
    }
    
    .tool-description {
      color: #999;
      margin-bottom: 10px;
    }
    
    .scan-status {
      color: #999;
      margin-left: 15px;
      font-size: 14px;
    }
    
    .spectrum-chart {
      width: 100%;
      max-width: 800px;
      height: 300px;
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      margin: 15px auto 0 auto;
      display: none;
    }
    
    .spectrum-chart.visible {
      display: block;
    }
    
    .channel-selector {
      margin-bottom: 15px;
    }
    
    .channel-selector > label {
      display: block;
      margin-bottom: 10px;
      color: #54b948;
      font-weight: bold;
    }
    
    .channel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 15px;
    }
    
    .channel-grid label {
      display: flex;
      align-items: center;
      gap: 5px;
      color: #e0e0e0;
      cursor: pointer;
    }
    
    .channel-grid label:hover {
      color: #54b948;
    }
    
    .channel-grid input[type="checkbox"] {
      margin: 0;
      cursor: pointer;
    }
    
    .channel-grid input[type="checkbox"]:focus {
      outline: none;
    }
    
    .channel-results {
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }
    
    .channel-results.visible {
      display: block;
    }
    
    .channel-result {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 10px;
      border-bottom: 1px solid #404040;
    }
    
    .channel-result:last-child {
      border-bottom: none;
    }
    
    .channel-result-name {
      min-width: 60px;
      font-weight: bold;
      color: #e0e0e0;
    }
    
    .channel-result-bar {
      flex: 1;
      height: 20px;
      background: #282828;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .channel-result-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .channel-result-fill.excellent {
      width: 100%;
      background: #27ae60;
    }
    
    .channel-result-fill.strong {
      width: 85%;
      background: #54b948;
    }
    
    .channel-result-fill.good {
      width: 65%;
      background: #95a5a6;
    }
    
    .channel-result-fill.weak {
      width: 45%;
      background: #f39c12;
    }
    
    .channel-result-fill.poor {
      width: 25%;
      background: #e67e22;
    }
    
    .channel-result-fill.none {
      width: 5%;
      background: #e74c3c;
    }
    
    .channel-result-fill.error {
      width: 10%;
      background: #95a5a6;
    }
    
    .channel-result-text {
      min-width: 120px;
      color: #ccc;
    }
    
    /* SNR Measurement Tool styles */
    .snr-config {
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .snr-config-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .snr-config-row label {
      color: #54b948;
      font-weight: bold;
      min-width: 80px;
    }
    
    .snr-config-row select,
    .snr-config-row input[type="number"] {
      background: #282828;
      border: 1px solid #404040;
      border-radius: 4px;
      color: #e0e0e0;
      padding: 6px 10px;
    }
    
    .snr-config-row span {
      color: #999;
    }
    
    .snr-results {
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .snr-best-gain {
      background: #282828;
      border: 2px solid #54b948;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 16px;
    }
    
    .snr-best-gain strong {
      color: #54b948;
      font-size: 24px;
    }
    
    .snr-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .snr-table th,
    .snr-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #404040;
    }
    
    .snr-table th {
      background: #282828;
      color: #54b948;
      font-weight: bold;
    }
    
    .snr-table td {
      color: #e0e0e0;
    }
    
    .snr-table tr:hover td {
      background: #282828;
    }
    
    .snr-table tr.best-row td {
      background: rgba(84, 185, 72, 0.2);
      font-weight: bold;
    }
    
    .workflow-guide {
      background: #1c1c1c;
      border: 1px solid #404040;
      border-radius: 4px;
      padding: 20px;
      margin-top: 30px;
    }
    
    .workflow-guide h4 {
      color: #54b948;
      margin-bottom: 15px;
    }
    
    .workflow-step {
      margin-bottom: 15px;
      padding-left: 10px;
      border-left: 3px solid #54b948;
    }
    
    .workflow-step strong {
      display: block;
      color: #e0e0e0;
      margin-bottom: 5px;
    }
    
    .workflow-step p {
      color: #999;
      margin: 0;
    }
    
    .workflow-note {
      margin-top: 20px;
      padding: 15px;
      background: #282828;
      border-radius: 4px;
      border-left: 3px solid #f39c12;
    }
    
    .workflow-note strong {
      display: block;
      color: #f39c12;
      margin-bottom: 5px;
    }
    
    .workflow-note p {
      color: #ccc;
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1 id="page-title">Station Management</h1>
      <div class="subtitle" id="page-subtitle">RTL-SDR Radio Plugin</div>
    </div>
    <button id="close-window-btn" class="header-close-btn hidden">
      <i class="fa fa-times"></i> <span id="close-btn-text">Close</span>
    </button>
  </div>
  
  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="fm">
        <i class="fa fa-signal"></i>
        <span id="tab-fm">FM Radio</span>
      </button>
      <button class="tab" data-tab="dab">
        <i class="fa fa-wifi"></i>
        <span id="tab-dab">DAB Radio</span>
      </button>
      <button class="tab" data-tab="recycle">
        <i class="fa fa-trash"></i>
        <span id="tab-recycle">Recycle Bin</span>
        <span class="tab-badge" id="recycle-count">0</span>
      </button>
      <button class="tab" data-tab="maintenance">
        <i class="fa fa-wrench"></i>
        <span id="tab-maintenance">Maintenance</span>
      </button>
      <button class="tab" data-tab="antenna">
        <i class="fa fa-adjust"></i>
        <span id="tab-antenna">Antenna Alignment</span>
      </button>
      <button class="tab" data-tab="blocklist">
        <i class="fa fa-ban"></i>
        <span id="tab-blocklist">Artwork Block List</span>
      </button>
    </div>
    
    <div id="fm-tab" class="tab-content active">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label"><i class="fa fa-list"></i> <span id="stat-total-label-fm">Total Stations</span></div>
          <div class="stat-value" id="fm-total">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fa fa-star"></i> <span id="stat-favorites-label-fm">Favorites</span></div>
          <div class="stat-value" id="fm-favorites">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fa fa-eye-slash"></i> <span id="stat-hidden-label-fm">Hidden</span></div>
          <div class="stat-value" id="fm-hidden">0</div>
        </div>
      </div>
      
      <div class="tab-header">
        <div class="search-bar">
          <input type="text" id="fm-search" placeholder="Search FM stations...">
          <i class="fa fa-search search-icon"></i>
        </div>
        <button class="btn btn-primary" id="rescan-fm-btn">
          <i class="fa fa-refresh"></i>
          <span id="btn-rescan-fm">Rescan FM</span>
        </button>
        <button class="btn btn-danger" id="clear-fm-btn">
          <i class="fa fa-trash"></i>
          <span id="btn-clear-fm">Clear All FM</span>
        </button>
        <div class="save-status-inline" id="save-status-inline">
          <i class="fa fa-check-circle"></i>
          <span id="status-text-inline">No changes</span>
        </div>
        <button class="btn btn-primary" id="save-btn-inline" disabled>
          <i class="fa fa-floppy-o"></i>
          <span id="btn-save-text-inline">Save</span>
        </button>
      </div>
      
      <div id="fm-list" class="station-list"></div>
    </div>
    
    <div id="dab-tab" class="tab-content">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label"><i class="fa fa-list"></i> <span id="stat-total-label-dab">Total Stations</span></div>
          <div class="stat-value" id="dab-total">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fa fa-star"></i> <span id="stat-favorites-label-dab">Favorites</span></div>
          <div class="stat-value" id="dab-favorites">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label"><i class="fa fa-eye-slash"></i> <span id="stat-hidden-label-dab">Hidden</span></div>
          <div class="stat-value" id="dab-hidden">0</div>
        </div>
      </div>
      
      <div class="tab-header">
        <div class="search-bar">
          <input type="text" id="dab-search" placeholder="Search DAB stations...">
          <i class="fa fa-search search-icon"></i>
        </div>
        <button class="btn btn-primary" id="rescan-dab-btn">
          <i class="fa fa-refresh"></i>
          <span id="btn-rescan-dab">Rescan DAB</span>
        </button>
        <button class="btn btn-danger" id="clear-dab-btn">
          <i class="fa fa-trash"></i>
          <span id="btn-clear-dab">Clear All DAB</span>
        </button>
      </div>
      
      <div id="dab-list" class="station-list"></div>
    </div>
    
    <div id="recycle-tab" class="tab-content">
      <div class="recycle-notice">
        <i class="fa fa-info-circle"></i>
        <div id="recycle-notice-text">Deleted stations are kept here until purged. You can restore them or permanently delete them.</div>
      </div>
      
      <div class="tab-header">
        <div class="search-bar">
          <input type="text" id="recycle-search" placeholder="Search deleted stations...">
          <i class="fa fa-search search-icon"></i>
        </div>
        <button class="btn btn-danger" id="empty-recycle-btn">
          <i class="fa fa-times-circle"></i>
          <span id="btn-empty-recycle">Empty Recycle Bin</span>
        </button>
      </div>
      
      <div id="recycle-list" class="station-list"></div>
    </div>
    
    <div id="maintenance-tab" class="tab-content">
      <div class="tab-header">
        <div class="flex-1">
          <h2 class="maintenance-header" id="maintenance-title">Backup & Restore</h2>
        </div>
      </div>
    
    <div class="backup-section">
      <h3 id="backup-title">Create Backup</h3>
      <div class="backup-form-row">
        <label>
          <input type="radio" name="backup-type" value="stations" checked>
          <span id="backup-stations">Stations Only</span>
        </label>
        <label>
          <input type="radio" name="backup-type" value="config">
          <span id="backup-config">Configuration Only</span>
        </label>
        <label>
          <input type="radio" name="backup-type" value="blocklist">
          <span id="backup-blocklist">Blocklist Only</span>
        </label>
        <label>
          <input type="radio" name="backup-type" value="full">
          <span id="backup-full">Full Backup (Everything)</span>
        </label>
      </div>
      <div class="backup-form-row">
        <label>
          <input type="checkbox" id="auto-backup-checkbox">
          <span id="auto-backup-label">Auto-backup before uninstall</span>
        </label>
      </div>
      <div class="tab-header tab-header-no-margin">
        <button class="btn btn-secondary" onclick="saveMaintenanceSettings()">
          <i class="fa fa-check"></i>
          <span id="btn-save-settings">Save Settings</span>
        </button>
        <button class="btn btn-primary" onclick="createBackup()">
          <i class="fa fa-floppy-o"></i>
          <span id="btn-create-backup">Create Backup Now</span>
        </button>
      </div>
    </div>
    
    <div class="backup-section">
      <h3 id="restore-system-title">Restore from System</h3>
      <div class="backup-grid backup-grid-3">
        <div>
          <label class="restore-label" id="restore-stations-label">Stations:</label>
          <select id="stations-restore-select" class="restore-select">
            <option value="">Latest</option>
          </select>
        </div>
        <div>
          <label class="restore-label" id="restore-config-label">Configuration:</label>
          <select id="config-restore-select" class="restore-select">
            <option value="">Latest</option>
          </select>
        </div>
        <div>
          <label class="restore-label" id="restore-blocklist-label">Blocklist:</label>
          <select id="blocklist-restore-select" class="restore-select">
            <option value="">Latest</option>
          </select>
        </div>
      </div>
      <div class="tab-header tab-header-no-margin">
        <button class="btn btn-warning" onclick="restoreSelected()">
          <i class="fa fa-refresh"></i>
          <span id="btn-restore-selected">Restore Selected</span>
        </button>
        <button class="btn btn-primary" onclick="restoreLatestFull()">
          <i class="fa fa-refresh"></i>
          <span id="btn-restore-latest">Restore Latest Full Backup</span>
        </button>
      </div>
    </div>
    
    <div class="backup-section">
      <h3 id="upload-title">Upload External Backup</h3>
      <input type="file" id="backup-upload" accept=".json,.zip" class="file-input-hidden">
      <div class="tab-header tab-header-no-margin">
        <button class="btn btn-secondary" onclick="document.getElementById('backup-upload').click()">
          <i class="fa fa-upload"></i>
          <span id="btn-choose-file">Choose File</span>
        </button>
        <span id="upload-filename" class="upload-filename"></span>
        <button class="btn btn-primary" id="upload-preview-btn" disabled onclick="uploadAndPreview()">
          <i class="fa fa-search"></i>
          <span id="btn-preview">Preview & Restore</span>
        </button>
      </div>
    </div>
    
    <div class="station-list">
      <div class="history-header">
        <h3 id="history-title">Backup History</h3>
      </div>
      <table class="history-table">
        <thead>
          <tr class="table-header-row">
            <th class="backup-table-header" id="th-type">Type</th>
            <th class="backup-table-header" id="th-date">Date</th>
            <th class="backup-table-header" id="th-size">Size</th>
            <th class="backup-table-header" id="th-download">Download</th>
            <th class="backup-table-header" id="th-delete">Delete</th>
          </tr>
        </thead>
        <tbody id="backup-history-body"></tbody>
      </table>
    </div>
    
    <!-- CSV Import/Export Section -->
    <div class="tab-header" style="margin-top: 30px;">
      <div class="flex-1">
        <h2 class="maintenance-header" id="csv-section-title">Import / Export Stations</h2>
      </div>
    </div>
    
    <div class="backup-section">
      <div class="csv-section-header" id="csv-export-header">Export</div>
      <p style="color: #888; font-size: 13px; margin-bottom: 15px;" id="csv-export-desc">Download your stations as CSV files for backup or editing.</p>
      <div class="tab-header tab-header-no-margin" style="margin-bottom: 20px;">
        <button class="btn btn-secondary" onclick="exportCsv('fm')">
          <i class="fa fa-download"></i>
          <span id="btn-export-fm">FM Stations</span>
        </button>
        <button class="btn btn-secondary" onclick="exportCsv('dab')">
          <i class="fa fa-download"></i>
          <span id="btn-export-dab">DAB Stations</span>
        </button>
      </div>
      
      <div class="csv-section-header" id="csv-templates-header">Templates</div>
      <p style="color: #888; font-size: 13px; margin-bottom: 15px;" id="csv-templates-desc">Download empty templates to create new station lists.</p>
      <div class="tab-header tab-header-no-margin" style="margin-bottom: 20px;">
        <button class="btn btn-secondary" onclick="downloadCsvTemplate('fm')">
          <i class="fa fa-file-text-o"></i>
          <span id="btn-template-fm">FM Template</span>
        </button>
        <button class="btn btn-secondary" onclick="downloadCsvTemplate('dab')">
          <i class="fa fa-file-text-o"></i>
          <span id="btn-template-dab">DAB Template</span>
        </button>
      </div>
      
      <div class="csv-section-header" id="csv-import-header">Import</div>
      <p style="color: #888; font-size: 13px; margin-bottom: 15px;" id="csv-import-desc">Upload a CSV file to add or update stations.</p>
      
      <input type="file" id="csv-file-input" accept=".csv" class="file-input-hidden" onchange="csvFileSelected()">
      <div class="tab-header tab-header-no-margin" style="margin-bottom: 15px;">
        <button class="btn btn-secondary" onclick="document.getElementById('csv-file-input').click()">
          <i class="fa fa-folder-open"></i>
          <span id="btn-csv-choose">Choose File</span>
        </button>
        <span id="csv-filename" class="upload-filename" style="color: #888;"></span>
      </div>
      
      <p style="color: #888; font-size: 13px; margin-bottom: 10px;" id="csv-operation-label">Import Operation:</p>
      <div class="csv-operation-grid">
        <label class="csv-operation-item">
          <input type="radio" name="csv-operation" value="replace">
          <div>
            <div class="csv-operation-label" id="csv-op-replace">Replace</div>
            <div class="csv-operation-desc" id="csv-op-replace-desc">Clear existing stations and import all from CSV</div>
          </div>
        </label>
        <label class="csv-operation-item">
          <input type="radio" name="csv-operation" value="amend">
          <div>
            <div class="csv-operation-label" id="csv-op-amend">Amend</div>
            <div class="csv-operation-desc" id="csv-op-amend-desc">Update matching stations, keep others unchanged</div>
          </div>
        </label>
        <label class="csv-operation-item">
          <input type="radio" name="csv-operation" value="extend" checked>
          <div>
            <div class="csv-operation-label" id="csv-op-extend">Extend</div>
            <div class="csv-operation-desc" id="csv-op-extend-desc">Add new stations only, skip duplicates</div>
          </div>
        </label>
        <label class="csv-operation-item">
          <input type="radio" name="csv-operation" value="remove">
          <div>
            <div class="csv-operation-label" id="csv-op-remove">Remove</div>
            <div class="csv-operation-desc" id="csv-op-remove-desc">Delete stations that match CSV entries</div>
          </div>
        </label>
      </div>
      
      <div class="tab-header tab-header-no-margin">
        <button class="btn btn-secondary" id="btn-csv-validate" onclick="validateCsv()" disabled>
          <i class="fa fa-check-circle"></i>
          <span id="btn-csv-validate-text">Validate</span>
        </button>
        <button class="btn btn-primary" id="btn-csv-import" onclick="importCsv()" disabled>
          <i class="fa fa-upload"></i>
          <span id="btn-csv-import-text">Import Stations</span>
        </button>
      </div>
      
      <div id="csv-validation-results">
        <div id="csv-validation-content"></div>
      </div>
    </div>
  </div>
  
    <div id="antenna-tab" class="tab-content">
      <div class="tab-header">
        <div class="flex-1">
          <h2 class="maintenance-header" id="antenna-header">Antenna Alignment</h2>
        </div>
      </div>
    
      <!-- Antenna Alignment Tools Section -->
      <div class="backup-section">
      <div class="antenna-info-box">
        <i class="fa fa-info-circle"></i>
        <span id="antenna-tools-desc">Use these tools to optimize antenna positioning for best DAB reception. Run spectrum scan first for quick overview, then validate specific channels.</span>
      </div>
      
      <!-- Tool 1: RF Spectrum Scan -->
      <div class="antenna-tool-section">
        <h4 id="tool-spectrum-title">Tool 1: RF Spectrum Scan</h4>
        <div class="antenna-tool-box">
          <p><strong id="spectrum-what">What it shows:</strong> <span id="spectrum-what-desc">Raw radio frequency power across entire DAB band (174-240 MHz)</span></p>
          <p><strong id="spectrum-use">Use when:</strong> <span id="spectrum-use-desc">Initial antenna positioning - quickly see WHERE signals exist in your area</span></p>
          <p><strong id="spectrum-speed">Speed:</strong> <span id="spectrum-speed-desc">2 seconds for full band</span></p>
          <p><strong id="spectrum-limit">Limitation:</strong> <span id="spectrum-limit-desc">Shows RF power only, NOT whether signal is decodable DAB</span></p>
        </div>
        
        <div class="tab-header tab-header-no-margin">
          <button class="btn btn-primary" onclick="scanSpectrum()">
            <i class="fa fa-line-chart"></i>
            <span id="btn-scan-spectrum">Scan RF Spectrum</span>
          </button>
          <span class="scan-status" id="spectrum-status"></span>
        </div>
        
        <canvas id="spectrum-chart" class="spectrum-chart" width="800" height="300"></canvas>
      </div>
      
      <!-- Tool 2: DAB Channel Validation -->
      <div class="antenna-tool-section">
        <h4 id="tool-validation-title">Tool 2: DAB Channel Validation</h4>
        <div class="antenna-tool-box">
          <p><strong id="validation-what">What it shows:</strong> <span id="validation-what-desc">Which DAB channels can actually be decoded and provide audio</span></p>
          <p><strong id="validation-use">Use when:</strong> <span id="validation-use-desc">Fine-tuning antenna after spectrum scan shows signals - verify decode capability</span></p>
          <p><strong id="validation-speed">Speed:</strong> <span id="validation-speed-desc">2 seconds per channel (~12-20 seconds total)</span></p>
          <p><strong id="validation-advantage">Advantage:</strong> <span id="validation-advantage-desc">Confirms real usable DAB stations</span></p>
        </div>
        
        <div class="channel-selector">
          <label id="channels-label">Select channels to check:</label>
          <div class="channel-grid">
            <label><input type="checkbox" class="channel-checkbox" value="5A"> 5A</label>
            <label><input type="checkbox" class="channel-checkbox" value="5B"> 5B</label>
            <label><input type="checkbox" class="channel-checkbox" value="5C"> 5C</label>
            <label><input type="checkbox" class="channel-checkbox" value="5D"> 5D</label>
            <label><input type="checkbox" class="channel-checkbox" value="6A"> 6A</label>
            <label><input type="checkbox" class="channel-checkbox" value="6B"> 6B</label>
            <label><input type="checkbox" class="channel-checkbox" value="6C"> 6C</label>
            <label><input type="checkbox" class="channel-checkbox" value="6D"> 6D</label>
            <label><input type="checkbox" class="channel-checkbox" value="7A"> 7A</label>
            <label><input type="checkbox" class="channel-checkbox" value="7B"> 7B</label>
            <label><input type="checkbox" class="channel-checkbox" value="7C"> 7C</label>
            <label><input type="checkbox" class="channel-checkbox" value="7D"> 7D</label>
            <label><input type="checkbox" class="channel-checkbox" value="8A"> 8A</label>
            <label><input type="checkbox" class="channel-checkbox" value="8B"> 8B</label>
            <label><input type="checkbox" class="channel-checkbox" value="8C"> 8C</label>
            <label><input type="checkbox" class="channel-checkbox" value="8D"> 8D</label>
            <label><input type="checkbox" class="channel-checkbox" value="9A"> 9A</label>
            <label><input type="checkbox" class="channel-checkbox" value="9B"> 9B</label>
            <label><input type="checkbox" class="channel-checkbox" value="9C"> 9C</label>
            <label><input type="checkbox" class="channel-checkbox" value="9D"> 9D</label>
            <label><input type="checkbox" class="channel-checkbox" value="10A"> 10A</label>
            <label><input type="checkbox" class="channel-checkbox" value="10B"> 10B</label>
            <label><input type="checkbox" class="channel-checkbox" value="10C"> 10C</label>
            <label><input type="checkbox" class="channel-checkbox" value="10D"> 10D</label>
            <label><input type="checkbox" class="channel-checkbox" value="11A"> 11A</label>
            <label><input type="checkbox" class="channel-checkbox" value="11B"> 11B</label>
            <label><input type="checkbox" class="channel-checkbox" value="11C"> 11C</label>
            <label><input type="checkbox" class="channel-checkbox" value="11D"> 11D</label>
            <label><input type="checkbox" class="channel-checkbox" value="12A"> 12A</label>
            <label><input type="checkbox" class="channel-checkbox" value="12B"> 12B</label>
            <label><input type="checkbox" class="channel-checkbox" value="12C"> 12C</label>
            <label><input type="checkbox" class="channel-checkbox" value="12D"> 12D</label>
            <label><input type="checkbox" class="channel-checkbox" value="13A"> 13A</label>
            <label><input type="checkbox" class="channel-checkbox" value="13B"> 13B</label>
            <label><input type="checkbox" class="channel-checkbox" value="13C"> 13C</label>
            <label><input type="checkbox" class="channel-checkbox" value="13D"> 13D</label>
            <label><input type="checkbox" class="channel-checkbox" value="13E"> 13E</label>
            <label><input type="checkbox" class="channel-checkbox" value="13F"> 13F</label>
          </div>
        </div>
        
        <div class="tab-header tab-header-no-margin">
          <button class="btn btn-primary" onclick="validateChannels()">
            <i class="fa fa-check-circle"></i>
            <span id="btn-validate-channels">Validate DAB Channels</span>
          </button>
          <span class="scan-status" id="validation-status"></span>
        </div>
        
        <div id="channel-results" class="channel-results"></div>
      </div>
      
      <!-- Tool 3: SNR Measurement -->
      <div class="antenna-tool-section">
        <h4 id="tool-snr-title">Tool 3: SNR Measurement (Gain Optimizer)</h4>
        <div class="antenna-tool-box">
          <p><strong id="snr-what">What it shows:</strong> <span id="snr-what-desc">Signal-to-Noise Ratio for each channel across different gain settings</span></p>
          <p><strong id="snr-use">Use when:</strong> <span id="snr-use-desc">Finding optimal gain setting for your location and antenna setup</span></p>
          <p><strong id="snr-speed">Speed:</strong> <span id="snr-speed-desc">2-3 seconds per gain step (total time depends on gain range)</span></p>
          <p><strong id="snr-advantage">Advantage:</strong> <span id="snr-advantage-desc">Automatically determines best gain for maximum signal quality</span></p>
        </div>
        
        <div class="snr-config">
          <div class="snr-config-row">
            <label id="snr-channels-label">Channels:</label>
            <select id="snr-channel-source" onchange="updateSnrChannelSource()">
              <option value="scanned" id="snr-source-scanned">Use scanned DAB stations</option>
              <option value="validated" id="snr-source-validated">Use validated channels (from Tool 2)</option>
              <option value="manual" id="snr-source-manual">Select manually</option>
            </select>
          </div>
          <div id="snr-manual-channels" class="channel-grid" style="display: none; margin-top: 10px;">
            <label><input type="checkbox" class="snr-channel-checkbox" value="5A"> 5A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="5B"> 5B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="5C"> 5C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="5D"> 5D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="6A"> 6A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="6B"> 6B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="6C"> 6C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="6D"> 6D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="7A"> 7A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="7B"> 7B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="7C"> 7C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="7D"> 7D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="8A"> 8A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="8B"> 8B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="8C"> 8C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="8D"> 8D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="9A"> 9A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="9B"> 9B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="9C"> 9C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="9D"> 9D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="10A"> 10A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="10B"> 10B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="10C"> 10C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="10D"> 10D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="11A"> 11A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="11B"> 11B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="11C"> 11C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="11D"> 11D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="12A"> 12A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="12B"> 12B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="12C"> 12C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="12D"> 12D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="13A"> 13A</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="13B"> 13B</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="13C"> 13C</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="13D"> 13D</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="13E"> 13E</label>
            <label><input type="checkbox" class="snr-channel-checkbox" value="13F"> 13F</label>
          </div>
          <div class="snr-config-row" style="margin-top: 10px;">
            <label id="snr-gain-label">Gain range:</label>
            <input type="number" id="snr-gain-start" value="0" min="-10" max="100" style="width: 60px;"> 
            <span>to</span>
            <input type="number" id="snr-gain-stop" value="50" min="-10" max="100" style="width: 60px;">
            <span id="snr-step-label">step</span>
            <input type="number" id="snr-gain-step" value="5" min="1" max="20" style="width: 50px;">
          </div>
          <div style="margin-top: 5px; font-size: 12px; color: #888;">
            <span id="snr-gain-note">RTL-SDR Blog V4 (R828D): extend range to 70 for optimal results</span>
          </div>
        </div>
        
        <div class="tab-header tab-header-no-margin">
          <button class="btn btn-primary" onclick="runSnrScan()">
            <i class="fa fa-sliders"></i>
            <span id="btn-snr-scan">Measure SNR</span>
          </button>
          <span class="scan-status" id="snr-status"></span>
        </div>
        
        <div id="snr-results" class="snr-results" style="display: none;">
          <div id="snr-best-gain" class="snr-best-gain"></div>
          <div id="snr-guidance" style="margin: 10px 0; padding: 10px; background: #2a2a2a; border-radius: 4px; font-size: 13px;">
            <span id="snr-guidance-text">Apply this value to DAB Gain in the plugin settings for optimal signal reception. The same value may work for FM Gain too.</span>
          </div>
          <table id="snr-summary-table" class="snr-table">
            <thead>
              <tr>
                <th id="snr-th-gain">Gain</th>
                <th id="snr-th-min">Min SNR</th>
                <th id="snr-th-max">Max SNR</th>
                <th id="snr-th-avg">Avg SNR</th>
              </tr>
            </thead>
            <tbody id="snr-summary-body"></tbody>
          </table>
          <div id="snr-details-toggle" style="margin-top: 10px;">
            <button class="btn btn-secondary" onclick="toggleSnrDetails()">
              <i class="fa fa-list"></i>
              <span id="btn-snr-details">Show Details</span>
            </button>
          </div>
          <div id="snr-details" style="display: none; margin-top: 10px;">
            <table class="snr-table">
              <thead>
                <tr>
                  <th id="snr-detail-th-gain">Gain</th>
                  <th id="snr-detail-th-channel">Channel</th>
                  <th id="snr-detail-th-peak">Peak (dB)</th>
                  <th id="snr-detail-th-noise">Noise (dB)</th>
                  <th id="snr-detail-th-snr">SNR (dB)</th>
                </tr>
              </thead>
              <tbody id="snr-details-body"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Workflow Guide -->
      <div class="workflow-guide">
        <h4 id="workflow-title">Antenna Alignment Workflow</h4>
        <div class="workflow-step">
          <strong id="workflow-step-1-title">Step 1: Run RF Spectrum Scan</strong>
          <p id="workflow-step-1-desc">See if ANY signals present in your location. Identify frequency ranges with activity. Quick overview (2 seconds).</p>
        </div>
        <div class="workflow-step">
          <strong id="workflow-step-2-title">Step 2: Adjust antenna based on spectrum</strong>
          <p id="workflow-step-2-desc">Rotate/reposition antenna for stronger peaks in spectrum display. Re-scan to compare results.</p>
        </div>
        <div class="workflow-step">
          <strong id="workflow-step-3-title">Step 3: Run DAB Channel Validation</strong>
          <p id="workflow-step-3-desc">Verify signals are actually DAB. Confirm decode capability. See which ensembles work reliably.</p>
        </div>
        <div class="workflow-step">
          <strong id="workflow-step-4-title">Step 4: Fine-tune based on validation</strong>
          <p id="workflow-step-4-desc">Adjust for maximum Strong or Excellent channels. Re-validate to confirm improvement.</p>
        </div>
        <div class="workflow-note">
          <strong id="workflow-note-title">Why use both tools?</strong>
          <p id="workflow-note-desc">Spectrum shows WHERE RF exists. Validation shows IF it's usable DAB. Strong RF does not guarantee decodable signal - could be interference or wrong modulation.</p>
        </div>
      </div>
    </div>
    </div>
    
    <div id="blocklist-tab" class="tab-content">
      <div class="tab-header">
        <div class="flex-1">
          <h2 class="maintenance-header" id="blocklist-title">Artwork Block List</h2>
        </div>
      </div>
      
      <div class="antenna-info-box">
        <i class="fa fa-info-circle"></i>
        <span id="blocklist-info">Add phrases that should NOT trigger artwork lookup. These are typically station slogans, show names, or promotional messages - not song metadata. One phrase per line.</span>
      </div>
      
      <div class="backup-section">
        <h3 id="blocklist-phrases-title">Blocked Phrases</h3>
        <div class="blocklist-textarea-container">
          <textarea id="blocklist-textarea" class="blocklist-textarea" rows="12" placeholder="We love pop!&#10;Best radio playing...&#10;Greatest Hits at Breakfast"></textarea>
        </div>
        <div class="blocklist-stats">
          <span id="blocklist-count">0 phrases</span>
        </div>
      </div>
      
      <div class="backup-section">
        <h3 id="blocklist-defaults-title">Default Patterns</h3>
        <div class="antenna-info-box" style="margin-bottom: 0;">
          <i class="fa fa-cog"></i>
          <span id="blocklist-defaults-info">The plugin includes built-in universal patterns for frequencies, URLs, phone numbers, and technical data. These cannot be edited but are always active.</span>
        </div>
      </div>
      
      <div class="tab-header tab-header-no-margin">
        <button class="btn btn-secondary" onclick="resetBlocklist()">
          <i class="fa fa-undo"></i>
          <span id="btn-reset-blocklist">Reset to Defaults</span>
        </button>
        <button class="btn btn-primary" onclick="saveBlocklist()">
          <i class="fa fa-floppy-o"></i>
          <span id="btn-save-blocklist">Save Block List</span>
        </button>
      </div>
    </div>
  </div>
  
  <div class="save-bar">
    <div class="info" id="save-status">
      <i class="fa fa-check-circle"></i>
      <span id="status-text">No changes</span>
    </div>
    <div class="actions">
      <button class="btn btn-primary" id="save-btn" disabled>
        <i class="fa fa-floppy-o"></i>
        <span id="btn-save-text">Save Changes</span>
      </button>
    </div>
  </div>
  
  <div class="toast" id="toast">
    <i class="fa fa-check-circle"></i>
    <span id="toast-message"></span>
  </div>
  
  <div class="modal-overlay" id="freq-modal">
    <div class="modal">
      <div class="modal-header warning">
        <i class="fa fa-exclamation-triangle"></i>
        <h2 id="freq-modal-title">Warning: Change Frequency?</h2>
      </div>
      <div class="modal-body">
        <p id="freq-modal-msg">You are about to change the frequency for "Station Name"</p>
        <div class="freq-comparison">
          <div class="freq-old">
            <label id="freq-old-label">From:</label>
            <span id="freq-old-value">98.7 MHz</span>
          </div>
          <div class="freq-arrow">
            <i class="fa fa-arrow-right"></i>
          </div>
          <div class="freq-new">
            <label id="freq-new-label">To:</label>
            <span id="freq-new-value">98.8 MHz</span>
          </div>
        </div>
        <p class="warning-text" id="freq-modal-details">This will affect playback. Make sure the new frequency is correct.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="freq-cancel">
          <span id="btn-cancel-text">Cancel</span>
        </button>
        <button class="btn btn-danger" id="freq-confirm">
          <i class="fa fa-check"></i>
          <span id="freq-confirm-text">Change Frequency</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Confirmation Modal -->
  <div class="modal-overlay" id="confirm-modal">
    <div class="modal">
      <div class="modal-header" id="confirm-modal-header">
        <i class="fa fa-question-circle" id="confirm-modal-icon"></i>
        <h2 id="confirm-modal-title">Confirm Action</h2>
      </div>
      <div class="modal-body">
        <p id="confirm-modal-message">Are you sure?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="confirm-cancel">
          <span id="confirm-cancel-text">Cancel</span>
        </button>
        <button class="btn btn-primary" id="confirm-ok">
          <span id="confirm-ok-text">Confirm</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Scanning Progress Modal -->
  <div class="modal-overlay" id="scanning-modal">
    <div class="modal">
      <div class="modal-header info" id="scanning-modal-header">
        <i class="fa fa-radio" id="scanning-modal-icon"></i>
        <h2 id="scanning-modal-title">Scanning</h2>
      </div>
      <div class="modal-body">
        <p id="scanning-modal-message">Scanning in progress...</p>
        <div class="spinner-container">
          <div class="spinner"></div>
        </div>
        <div class="elapsed-time">
          <span id="elapsed-label">Elapsed time:</span>
          <span class="time-value" id="elapsed-value">0</span>
          <span id="elapsed-unit">seconds</span>
        </div>
        <div class="scanning-info" id="scanning-info">
          This typically takes a few seconds
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let fmStations = [];
    let dabStations = [];
    let hasChanges = false;
    let i18n = {};
    let pendingFreqChange = null;
    let scanningInterval = null;
    let scanStartTime = null;
    let currentSignal = null;
    let signalPollInterval = null;
    
    // i18n functions
    function t(key, ...args) {
      let str = i18n[key] || key;
      args.forEach((arg, index) => {
        str = str.replace('{' + index + '}', arg);
      });
      return str;
    }
    
    // Generic confirmation modal
    function showConfirmModal(title, message, type = 'warning') {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirm-modal');
        const header = document.getElementById('confirm-modal-header');
        const icon = document.getElementById('confirm-modal-icon');
        
        // Set header style based on type
        header.className = 'modal-header';
        if (type === 'danger') {
          header.classList.add('danger');
          icon.className = 'fa fa-exclamation-triangle';
        } else if (type === 'warning') {
          header.classList.add('warning');
          icon.className = 'fa fa-exclamation-circle';
        } else if (type === 'info') {
          header.classList.add('info');
          icon.className = 'fa fa-question-circle';
        }
        
        // Set content
        document.getElementById('confirm-modal-title').textContent = title;
        document.getElementById('confirm-modal-message').textContent = message;
        document.getElementById('confirm-cancel-text').textContent = t('BTN_CANCEL');
        document.getElementById('confirm-ok-text').textContent = t('BTN_CONFIRM');
        
        // Show modal
        modal.classList.add('show');
        
        // Set up event handlers
        const handleOk = () => {
          modal.classList.remove('show');
          cleanup();
          resolve(true);
        };
        
        const handleCancel = () => {
          modal.classList.remove('show');
          cleanup();
          resolve(false);
        };
        
        const cleanup = () => {
          document.getElementById('confirm-ok').removeEventListener('click', handleOk);
          document.getElementById('confirm-cancel').removeEventListener('click', handleCancel);
        };
        
        document.getElementById('confirm-ok').addEventListener('click', handleOk);
        document.getElementById('confirm-cancel').addEventListener('click', handleCancel);
      });
    }
    
    // Format elapsed time as "Xm Ys" or "Xs"
    function formatElapsedTime(seconds) {
      if (seconds < 60) {
        return seconds + 's';
      }
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      return minutes + 'm ' + remainingSeconds + 's';
    }
    
    // Show scanning progress modal
    function showScanningModal(type) {
      const modal = document.getElementById('scanning-modal');
      const title = type === 'fm' ? t('MODAL_SCANNING_FM_TITLE') : t('MODAL_SCANNING_DAB_TITLE');
      const message = t('MODAL_SCANNING_PROGRESS');
      const info = type === 'fm' ? t('MODAL_SCANNING_WAIT_FM') : t('MODAL_SCANNING_WAIT_DAB');
      
      document.getElementById('scanning-modal-title').textContent = title;
      document.getElementById('scanning-modal-message').textContent = message;
      document.getElementById('scanning-info').textContent = info;
      document.getElementById('elapsed-value').textContent = '0s';
      document.getElementById('elapsed-label').textContent = t('MODAL_ELAPSED_LABEL');
      document.getElementById('elapsed-unit').textContent = '';
      
      modal.classList.add('show');
      
      // Start elapsed time counter
      scanStartTime = Date.now();
      scanningInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - scanStartTime) / 1000);
        document.getElementById('elapsed-value').textContent = formatElapsedTime(elapsed);
      }, 1000);
    }
    
    // Hide scanning modal
    function hideScanningModal() {
      const modal = document.getElementById('scanning-modal');
      modal.classList.remove('show');
      
      if (scanningInterval) {
        clearInterval(scanningInterval);
        scanningInterval = null;
      }
      scanStartTime = null;
    }
    
    // Poll scanning status
    async function pollScanStatus(type) {
      const expectedState = type === 'fm' ? 'scanning_fm' : 'scanning_dab';
      
      const checkStatus = async () => {
        try {
          const response = await fetch('/api/status');
          if (!response.ok) {
            throw new Error('Status check failed');
          }
          
          const data = await response.json();
          
          if (data.deviceState !== expectedState) {
            // Scan complete
            hideScanningModal();
            showToast(t('TOAST_SCAN_COMPLETE_RELOAD'), 'success');
            setTimeout(() => loadStations(), 1000);
            return;
          }
          
          // Still scanning, check again
          setTimeout(checkStatus, 2000);
          
        } catch (error) {
          // Network error, keep trying
          setTimeout(checkStatus, 2000);
        }
      };
      
      // Start polling after short delay
      setTimeout(checkStatus, 2000);
    }
    
    async function loadTranslations() {
      try {
        // Fetch current Volumio language setting from server
        const langResponse = await fetch('/api/language');
        const langData = await langResponse.json();
        const lang = langData.language || 'en';
        
        // Fetch translations for that language
        const response = await fetch('/api/i18n/' + lang);
        i18n = await response.json();
        updateUIText();
      } catch (error) {
        console.error('Failed to load translations:', error);
        // Fallback to English on error
        try {
          const response = await fetch('/api/i18n/en');
          i18n = await response.json();
          updateUIText();
        } catch (fallbackError) {
          console.error('Failed to load fallback translations:', fallbackError);
        }
      }
    }
    
    function updateUIText() {
      document.getElementById('page-title').textContent = t('WEB_MANAGER_TITLE');
      document.getElementById('page-subtitle').textContent = t('WEB_MANAGER_SUBTITLE');
      document.getElementById('tab-fm').textContent = t('TAB_FM_RADIO');
      document.getElementById('tab-dab').textContent = t('TAB_DAB_RADIO');
      document.getElementById('tab-recycle').textContent = t('TAB_RECYCLE_BIN');
      document.getElementById('stat-total-label-fm').textContent = t('STAT_TOTAL');
      document.getElementById('stat-favorites-label-fm').textContent = t('STAT_FAVORITES');
      document.getElementById('stat-hidden-label-fm').textContent = t('STAT_HIDDEN');
      document.getElementById('stat-total-label-dab').textContent = t('STAT_TOTAL');
      document.getElementById('stat-favorites-label-dab').textContent = t('STAT_FAVORITES');
      document.getElementById('stat-hidden-label-dab').textContent = t('STAT_HIDDEN');
      document.getElementById('btn-clear-fm').textContent = t('BTN_CLEAR_ALL_FM');
      document.getElementById('btn-rescan-fm').textContent = t('BTN_RESCAN_FM');
      document.getElementById('btn-clear-dab').textContent = t('BTN_CLEAR_ALL_DAB');
      document.getElementById('btn-rescan-dab').textContent = t('BTN_RESCAN_DAB');
      document.getElementById('btn-empty-recycle').textContent = t('BTN_EMPTY_RECYCLE');
      document.getElementById('btn-save-text').textContent = t('BTN_SAVE');
      document.getElementById('btn-save-text-inline').textContent = t('BTN_SAVE');
      document.getElementById('btn-cancel-text').textContent = t('BTN_CANCEL');
      document.getElementById('recycle-notice-text').textContent = t('RECYCLE_NOTICE');
      document.getElementById('fm-search').placeholder = t('SEARCH_FM');
      document.getElementById('dab-search').placeholder = t('SEARCH_DAB');
      document.getElementById('recycle-search').placeholder = t('SEARCH_RECYCLE');
      document.getElementById('close-btn-text').textContent = t('CLOSE_WINDOW');
      
      // Maintenance tab translations
      document.getElementById('tab-maintenance').textContent = t('TAB_MAINTENANCE');
      document.getElementById('maintenance-title').textContent = t('MAINTENANCE_TITLE');
      document.getElementById('backup-title').textContent = t('MAINTENANCE_BACKUP_TITLE');
      document.getElementById('backup-stations').textContent = t('MAINTENANCE_BACKUP_TYPE_STATIONS');
      document.getElementById('backup-config').textContent = t('MAINTENANCE_BACKUP_TYPE_CONFIG');
      document.getElementById('backup-blocklist').textContent = t('MAINTENANCE_BACKUP_TYPE_BLOCKLIST');
      document.getElementById('backup-full').textContent = t('MAINTENANCE_BACKUP_TYPE_FULL');
      document.getElementById('auto-backup-label').textContent = t('MAINTENANCE_AUTO_BACKUP');
      document.getElementById('btn-save-settings').textContent = t('BTN_SAVE_SETTINGS');
      document.getElementById('btn-create-backup').textContent = t('MAINTENANCE_CREATE_BACKUP');
      document.getElementById('restore-system-title').textContent = t('MAINTENANCE_RESTORE_SYSTEM_TITLE');
      document.getElementById('restore-stations-label').textContent = t('MAINTENANCE_RESTORE_STATIONS');
      document.getElementById('restore-config-label').textContent = t('MAINTENANCE_RESTORE_CONFIG');
      document.getElementById('restore-blocklist-label').textContent = t('MAINTENANCE_RESTORE_BLOCKLIST');
      document.getElementById('btn-restore-selected').textContent = t('MAINTENANCE_RESTORE_SELECTED');
      document.getElementById('btn-restore-latest').textContent = t('MAINTENANCE_RESTORE_LATEST_FULL');
      document.getElementById('upload-title').textContent = t('MAINTENANCE_UPLOAD_TITLE');
      document.getElementById('btn-choose-file').textContent = t('BTN_CHOOSE_FILE');
      document.getElementById('btn-preview').textContent = t('MAINTENANCE_UPLOAD_RESTORE');
      document.getElementById('history-title').textContent = t('MAINTENANCE_HISTORY_TITLE');
      document.getElementById('th-type').textContent = t('TH_TYPE');
      document.getElementById('th-date').textContent = t('TH_DATE');
      document.getElementById('th-size').textContent = t('TH_SIZE');
      document.getElementById('th-download').textContent = t('TH_DOWNLOAD');
      document.getElementById('th-delete').textContent = t('TH_DELETE');
      
      // CSV Import/Export translations
      document.getElementById('csv-section-title').textContent = t('CSV_IMPORT_EXPORT');
      document.getElementById('csv-export-header').textContent = t('CSV_EXPORT_TITLE');
      document.getElementById('csv-export-desc').textContent = t('CSV_EXPORT_DESC');
      document.getElementById('btn-export-fm').textContent = t('CSV_EXPORT_FM');
      document.getElementById('btn-export-dab').textContent = t('CSV_EXPORT_DAB');
      document.getElementById('csv-templates-header').textContent = t('CSV_TEMPLATES_TITLE');
      document.getElementById('csv-templates-desc').textContent = t('CSV_TEMPLATES_DESC');
      document.getElementById('btn-template-fm').textContent = t('CSV_TEMPLATE_FM');
      document.getElementById('btn-template-dab').textContent = t('CSV_TEMPLATE_DAB');
      document.getElementById('csv-import-header').textContent = t('CSV_IMPORT_TITLE');
      document.getElementById('csv-import-desc').textContent = t('CSV_IMPORT_DESC');
      document.getElementById('btn-csv-choose').textContent = t('CSV_CHOOSE_FILE');
      document.getElementById('csv-filename').textContent = t('CSV_NO_FILE');
      document.getElementById('csv-operation-label').textContent = t('CSV_OPERATION') + ':';
      document.getElementById('csv-op-replace').textContent = t('CSV_OP_REPLACE');
      document.getElementById('csv-op-replace-desc').textContent = t('CSV_OP_REPLACE_DESC');
      document.getElementById('csv-op-amend').textContent = t('CSV_OP_AMEND');
      document.getElementById('csv-op-amend-desc').textContent = t('CSV_OP_AMEND_DESC');
      document.getElementById('csv-op-extend').textContent = t('CSV_OP_EXTEND');
      document.getElementById('csv-op-extend-desc').textContent = t('CSV_OP_EXTEND_DESC');
      document.getElementById('csv-op-remove').textContent = t('CSV_OP_REMOVE');
      document.getElementById('csv-op-remove-desc').textContent = t('CSV_OP_REMOVE_DESC');
      document.getElementById('btn-csv-validate-text').textContent = t('CSV_VALIDATE');
      document.getElementById('btn-csv-import-text').textContent = t('CSV_IMPORT_BTN');
      
      // Antenna Alignment tab translations
      document.getElementById('tab-antenna').textContent = t('TAB_ANTENNA');
      document.getElementById('antenna-header').textContent = t('ANTENNA_HEADER');
      document.getElementById('antenna-tools-desc').textContent = t('ANTENNA_TOOLS_DESC');
      
      // Tool 1: RF Spectrum Scan
      document.getElementById('tool-spectrum-title').textContent = t('TOOL_SPECTRUM_TITLE');
      document.getElementById('spectrum-what').textContent = t('SPECTRUM_WHAT');
      document.getElementById('spectrum-what-desc').textContent = t('SPECTRUM_WHAT_DESC');
      document.getElementById('spectrum-use').textContent = t('SPECTRUM_USE');
      document.getElementById('spectrum-use-desc').textContent = t('SPECTRUM_USE_DESC');
      document.getElementById('spectrum-speed').textContent = t('SPECTRUM_SPEED');
      document.getElementById('spectrum-speed-desc').textContent = t('SPECTRUM_SPEED_DESC');
      document.getElementById('spectrum-limit').textContent = t('SPECTRUM_LIMIT');
      document.getElementById('spectrum-limit-desc').textContent = t('SPECTRUM_LIMIT_DESC');
      document.getElementById('btn-scan-spectrum').textContent = t('BTN_SCAN_SPECTRUM');
      
      // Tool 2: DAB Channel Validation
      document.getElementById('tool-validation-title').textContent = t('TOOL_VALIDATION_TITLE');
      document.getElementById('validation-what').textContent = t('VALIDATION_WHAT');
      document.getElementById('validation-what-desc').textContent = t('VALIDATION_WHAT_DESC');
      document.getElementById('validation-use').textContent = t('VALIDATION_USE');
      document.getElementById('validation-use-desc').textContent = t('VALIDATION_USE_DESC');
      document.getElementById('validation-speed').textContent = t('VALIDATION_SPEED');
      document.getElementById('validation-speed-desc').textContent = t('VALIDATION_SPEED_DESC');
      document.getElementById('validation-advantage').textContent = t('VALIDATION_ADVANTAGE');
      document.getElementById('validation-advantage-desc').textContent = t('VALIDATION_ADVANTAGE_DESC');
      document.getElementById('channels-label').textContent = t('CHANNELS_LABEL');
      document.getElementById('btn-validate-channels').textContent = t('BTN_VALIDATE_CHANNELS');
      
      // Tool 3: SNR Measurement
      document.getElementById('tool-snr-title').textContent = t('TOOL_SNR_TITLE');
      document.getElementById('snr-what').textContent = t('SNR_WHAT');
      document.getElementById('snr-what-desc').textContent = t('SNR_WHAT_DESC');
      document.getElementById('snr-use').textContent = t('SNR_USE');
      document.getElementById('snr-use-desc').textContent = t('SNR_USE_DESC');
      document.getElementById('snr-speed').textContent = t('SNR_SPEED');
      document.getElementById('snr-speed-desc').textContent = t('SNR_SPEED_DESC');
      document.getElementById('snr-advantage').textContent = t('SNR_ADVANTAGE');
      document.getElementById('snr-advantage-desc').textContent = t('SNR_ADVANTAGE_DESC');
      document.getElementById('snr-channels-label').textContent = t('SNR_CHANNELS_LABEL');
      document.getElementById('snr-source-scanned').textContent = t('SNR_SOURCE_SCANNED');
      document.getElementById('snr-source-validated').textContent = t('SNR_SOURCE_VALIDATED');
      document.getElementById('snr-source-manual').textContent = t('SNR_SOURCE_MANUAL');
      document.getElementById('snr-gain-label').textContent = t('SNR_GAIN_LABEL');
      document.getElementById('snr-step-label').textContent = t('SNR_STEP_LABEL');
      document.getElementById('btn-snr-scan').textContent = t('BTN_SNR_SCAN');
      document.getElementById('snr-th-gain').textContent = t('SNR_TH_GAIN');
      document.getElementById('snr-th-min').textContent = t('SNR_TH_MIN');
      document.getElementById('snr-th-max').textContent = t('SNR_TH_MAX');
      document.getElementById('snr-th-avg').textContent = t('SNR_TH_AVG');
      document.getElementById('btn-snr-details').textContent = t('SNR_SHOW_DETAILS');
      document.getElementById('snr-detail-th-gain').textContent = t('SNR_TH_GAIN');
      document.getElementById('snr-detail-th-channel').textContent = t('SNR_TH_CHANNEL');
      document.getElementById('snr-detail-th-peak').textContent = t('SNR_TH_PEAK');
      document.getElementById('snr-detail-th-noise').textContent = t('SNR_TH_NOISE');
      document.getElementById('snr-detail-th-snr').textContent = t('SNR_TH_SNR');
      document.getElementById('snr-guidance-text').textContent = t('SNR_GUIDANCE');
      document.getElementById('snr-gain-note').textContent = t('SNR_GAIN_NOTE');
      
      // Antenna Alignment Workflow
      document.getElementById('workflow-title').textContent = t('WORKFLOW_TITLE');
      document.getElementById('workflow-step-1-title').textContent = t('WORKFLOW_STEP_1_TITLE');
      document.getElementById('workflow-step-1-desc').textContent = t('WORKFLOW_STEP_1_DESC');
      document.getElementById('workflow-step-2-title').textContent = t('WORKFLOW_STEP_2_TITLE');
      document.getElementById('workflow-step-2-desc').textContent = t('WORKFLOW_STEP_2_DESC');
      document.getElementById('workflow-step-3-title').textContent = t('WORKFLOW_STEP_3_TITLE');
      document.getElementById('workflow-step-3-desc').textContent = t('WORKFLOW_STEP_3_DESC');
      document.getElementById('workflow-step-4-title').textContent = t('WORKFLOW_STEP_4_TITLE');
      document.getElementById('workflow-step-4-desc').textContent = t('WORKFLOW_STEP_4_DESC');
      document.getElementById('workflow-note-title').textContent = t('WORKFLOW_NOTE_TITLE');
      document.getElementById('workflow-note-desc').textContent = t('WORKFLOW_NOTE_DESC');
      
      // Artwork Block List tab translations
      document.getElementById('tab-blocklist').textContent = t('TAB_BLOCKLIST');
      document.getElementById('blocklist-title').textContent = t('BLOCKLIST_TITLE');
      document.getElementById('blocklist-info').textContent = t('BLOCKLIST_INFO');
      document.getElementById('blocklist-phrases-title').textContent = t('BLOCKLIST_PHRASES_TITLE');
      document.getElementById('blocklist-textarea').placeholder = t('BLOCKLIST_PLACEHOLDER');
      document.getElementById('blocklist-defaults-title').textContent = t('BLOCKLIST_DEFAULTS_TITLE');
      document.getElementById('blocklist-defaults-info').textContent = t('BLOCKLIST_DEFAULTS_INFO');
      document.getElementById('btn-reset-blocklist').textContent = t('BTN_RESET_BLOCKLIST');
      document.getElementById('btn-save-blocklist').textContent = t('BTN_SAVE_BLOCKLIST');
      updateBlocklistCount();
      
      // Show close button only when opened in new tab (not in iframe)
      const closeBtn = document.getElementById('close-window-btn');
      if (window.parent === window) {
        // Opened in new tab/window, show close button
        closeBtn.classList.remove('hidden');
      } else {
        // Opened in iframe, hide close button
        closeBtn.classList.add('hidden');
      }
    }
    
    function closeWindow() {
      window.close();
      
      setTimeout(function() {
        if (!window.closed) {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = '/';
          }
        }
      }, 100);
    }
    
    document.getElementById('close-window-btn').addEventListener('click', closeWindow);
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        const tabId = tab.dataset.tab + '-tab';
        document.getElementById(tabId).classList.add('active');
      });
    });
    
    // Load stations
    async function loadStations() {
      try {
        const response = await fetch('/api/stations');
        const data = await response.json();
        
        fmStations = data.fm || [];
        dabStations = data.dab || [];
        
        // Clean up any dirty flags that might have been saved to backend
        fmStations.forEach(s => delete s.dirty);
        dabStations.forEach(s => delete s.dirty);
        
        renderStations('fm', fmStations);
        renderStations('dab', dabStations);
        renderRecycleBin();
        updateStats();
        updateRecycleCount();
        
        hasChanges = false;
        updateSaveStatus(t('STATUS_NO_CHANGES'), false);
        document.getElementById('save-btn').disabled = true;
        
      } catch (error) {
        showToast(t('TOAST_LOAD_FAILED', error.message), 'error');
      }
    }
    
    // Render station list
    function renderStations(type, stations) {
      const listEl = document.getElementById(type + '-list');
      const searchEl = document.getElementById(type + '-search');
      const searchTerm = searchEl.value.toLowerCase();
      
      let filtered = stations.filter(s => !s.deleted);
      if (searchTerm) {
        filtered = filtered.filter(s => {
          const name = s.customName || s.name || '';
          const freq = type === 'fm' ? s.frequency : s.channelName || '';
          return name.toLowerCase().includes(searchTerm) || 
                 freq.toString().toLowerCase().includes(searchTerm);
        });
      }
      
      if (filtered.length === 0) {
        const emptyKey = type === 'fm' ? 'EMPTY_FM' : 'EMPTY_DAB';
        listEl.innerHTML = '<div class="empty-state"><i class="fa fa-radio"></i><div class="empty-state-text">' + t(emptyKey) + '</div></div>';
        return;
      }
      
      listEl.innerHTML = filtered.map((station) => {
        const realIdx = stations.indexOf(station);
        const displayName = station.customName || station.name || t('STATION_NAME_UNKNOWN');
        
        let icon = '';
        if (station.favorite) {
          icon = '<i class="fa fa-star station-icon favorite"></i>';
        } else if (station.hidden) {
          icon = '<i class="fa fa-eye-slash station-icon hidden-icon"></i>';
        } else {
          icon = '<i class="fa fa-circle-o station-icon"></i>';
        }
        
        const favoriteClass = station.favorite ? 'active favorite' : '';
        const hiddenClass = station.hidden ? 'active hidden' : '';
        
        let frequencyHtml = '';
        if (type === 'fm') {
          frequencyHtml = '<input type="number" class="frequency-input" value="' + station.frequency + '" min="76.0" max="108.0" step="0.1" data-type="fm" data-index="' + realIdx + '" data-original="' + station.frequency + '" title="' + t('LABEL_FREQUENCY') + '">';
        } else {
          frequencyHtml = '<span class="frequency-display">' + (station.channelName || '') + '</span>';
        }
        
        // Check if this station is currently playing
        let isPlaying = false;
        let signalHtml = '';
        if (currentSignal) {
          if (type === 'fm' && currentSignal.type === 'fm' && 
              Math.abs(station.frequency - currentSignal.frequency) < 0.05) {
            isPlaying = true;
          } else if (type === 'dab' && currentSignal.type === 'dab' && 
                     currentSignal.station && station.exactName === currentSignal.station.exactName) {
            isPlaying = true;
          }
          
          if (isPlaying) {
            const level = currentSignal.level || 0;
            signalHtml = `<div class="signal-indicator signal-${level}">
              <i class="fa fa-signal"></i>
              <span class="signal-text">${level}/5</span>
            </div>`;
          }
        }
        
        const playingClass = isPlaying ? ' now-playing' : '';
        
        return `
          <div class="station-item${station.dirty ? ' dirty' : ''}${playingClass}" data-type="${type}" data-index="${realIdx}" data-frequency="${station.frequency || ''}" data-exactname="${station.exactName || ''}">
            ${icon}
            <div class="station-info">
              <div class="station-name">
                <input type="text" class="station-name-input" value="${escapeHtml(displayName)}" data-type="${type}" data-index="${realIdx}" placeholder="${t('PLACEHOLDER_STATION_NAME')}">
              </div>
              <div class="station-details">
                ${frequencyHtml}
              </div>
            </div>
            ${signalHtml}
            <div class="station-actions">
              <button class="btn btn-icon ${favoriteClass}" title="${t('BTN_FAVORITE')}" data-type="${type}" data-index="${realIdx}" data-action="favorite">
                <i class="fa ${station.favorite ? 'fa-star' : 'fa-star-o'}"></i>
              </button>
              <button class="btn btn-icon ${hiddenClass}" title="${t('BTN_HIDDEN')}" data-type="${type}" data-index="${realIdx}" data-action="hidden">
                <i class="fa ${station.hidden ? 'fa-eye-slash' : 'fa-eye'}"></i>
              </button>
              <button class="btn btn-danger" title="${t('BTN_DELETE')}" data-type="${type}" data-index="${realIdx}" data-action="delete">
                <i class="fa fa-trash"></i>
              </button>
              <button class="btn btn-save-row" title="${t('BTN_SAVE')}" data-type="${type}" data-index="${realIdx}" data-action="save-row">
                <i class="fa fa-floppy-o"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      attachEventListeners(type);
    }
    
    // Render recycle bin
    function renderRecycleBin() {
      const listEl = document.getElementById('recycle-list');
      const searchEl = document.getElementById('recycle-search');
      const searchTerm = searchEl.value.toLowerCase();
      
      const deletedFm = fmStations.filter(s => s.deleted).map(s => ({...s, type: 'fm'}));
      const deletedDab = dabStations.filter(s => s.deleted).map(s => ({...s, type: 'dab'}));
      let allDeleted = [...deletedFm, ...deletedDab];
      
      if (searchTerm) {
        allDeleted = allDeleted.filter(s => {
          const name = s.customName || s.name || '';
          return name.toLowerCase().includes(searchTerm);
        });
      }
      
      if (allDeleted.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><i class="fa fa-check-circle"></i><div class="empty-state-text">' + t('EMPTY_RECYCLE') + '</div></div>';
        return;
      }
      
      listEl.innerHTML = allDeleted.map(station => {
        const stations = station.type === 'fm' ? fmStations : dabStations;
        const realIdx = stations.indexOf(stations.find(s => 
          (station.type === 'fm' ? s.frequency === station.frequency : s.exactName === station.exactName)
        ));
        
        const displayName = station.customName || station.name || t('STATION_NAME_UNKNOWN');
        const frequency = station.type === 'fm' ? station.frequency + ' MHz' : (station.channelName || '');
        const typeLabel = station.type.toUpperCase();
        
        return `
          <div class="station-item deleted" data-type="${station.type}" data-index="${realIdx}">
            <i class="fa fa-trash station-icon"></i>
            <div class="station-info">
              <div class="station-name">
                <span class="station-type-badge">${typeLabel}</span>
                ${escapeHtml(displayName)}
              </div>
              <div class="station-details">${frequency}</div>
            </div>
            <div class="station-actions">
              <button class="btn btn-warning" title="${t('BTN_RESTORE')}" data-type="${station.type}" data-index="${realIdx}" data-action="restore">
                <i class="fa fa-undo"></i>
                <span>${t('BTN_RESTORE')}</span>
              </button>
              <button class="btn btn-danger" title="${t('BTN_PURGE')}" data-type="${station.type}" data-index="${realIdx}" data-action="purge-one">
                <i class="fa fa-times-circle"></i>
                <span>${t('BTN_PURGE')}</span>
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      attachRecycleEventListeners();
    }
    
    // Attach event listeners
    function attachEventListeners(type) {
      document.querySelectorAll(`input.station-name-input[data-type="${type}"]`).forEach(input => {
        input.addEventListener('input', (e) => {
          const idx = parseInt(e.target.dataset.index);
          const stations = type === 'fm' ? fmStations : dabStations;
          stations[idx].customName = e.target.value;
          markRowDirty(type, idx);
        });
      });
      
      document.querySelectorAll(`input.frequency-input[data-type="${type}"]`).forEach(input => {
        input.addEventListener('blur', (e) => {
          const idx = parseInt(e.target.dataset.index);
          const newFreq = parseFloat(e.target.value);
          const oldFreq = parseFloat(e.target.dataset.original);
          
          if (newFreq === oldFreq) return;
          
          if (newFreq < 76.0 || newFreq > 108.0 || isNaN(newFreq)) {
            showToast(t('WARN_FREQ_INVALID'), 'error');
            e.target.value = oldFreq;
            e.target.classList.add('error');
            setTimeout(() => e.target.classList.remove('error'), 2000);
            return;
          }
          
          const stations = fmStations;
          const station = stations[idx];
          
          pendingFreqChange = {
            type: type,
            index: idx,
            oldFreq: oldFreq,
            newFreq: newFreq,
            stationName: station.customName || station.name,
            inputEl: e.target
          };
          
          showFrequencyWarning();
        });
      });
      
      document.querySelectorAll(`button[data-type="${type}"]`).forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const idx = parseInt(e.currentTarget.dataset.index);
          const action = e.currentTarget.dataset.action;
          const stations = type === 'fm' ? fmStations : dabStations;
          
          if (action === 'save-row') {
            // Save this specific row
            await saveRow(type, idx);
            return;
          }
          
          if (action === 'favorite') {
            stations[idx].favorite = !stations[idx].favorite;
          } else if (action === 'hidden') {
            stations[idx].hidden = !stations[idx].hidden;
          } else if (action === 'delete') {
            if (confirm(t('CONFIRM_DELETE_ONE'))) {
              stations[idx].deleted = true;
            } else {
              return;
            }
          }
          
          markRowDirty(type, idx);
          renderStations(type, stations);
          renderRecycleBin();
          updateStats();
          updateRecycleCount();
        });
      });
    }
    
    // Attach recycle bin event listeners
    function attachRecycleEventListeners() {
      document.querySelectorAll('#recycle-list button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = parseInt(e.currentTarget.dataset.index);
          const action = e.currentTarget.dataset.action;
          const type = e.currentTarget.dataset.type;
          const stations = type === 'fm' ? fmStations : dabStations;
          
          if (action === 'restore') {
            stations[idx].deleted = false;
            markChanged();
            renderStations(type, stations);
            renderRecycleBin();
            updateStats();
            updateRecycleCount();
            showToast(t('TOAST_RESTORED'));
          } else if (action === 'purge-one') {
            if (confirm(t('CONFIRM_PURGE_ONE'))) {
              if (type === 'fm') {
                fmStations.splice(idx, 1);
              } else {
                dabStations.splice(idx, 1);
              }
              markChanged();
              renderRecycleBin();
              updateRecycleCount();
              showToast(t('TOAST_PURGED'), 'warning');
            }
          }
        });
      });
    }
    
    // Frequency change warning modal
    function showFrequencyWarning() {
      if (!pendingFreqChange) return;
      
      const modal = document.getElementById('freq-modal');
      document.getElementById('freq-modal-title').textContent = t('WARN_FREQ_CHANGE_TITLE');
      document.getElementById('freq-modal-msg').textContent = t('WARN_FREQ_CHANGE_MSG', pendingFreqChange.stationName);
      document.getElementById('freq-old-label').textContent = t('WARN_FREQ_CHANGE_FROM');
      document.getElementById('freq-new-label').textContent = t('WARN_FREQ_CHANGE_TO');
      document.getElementById('freq-old-value').textContent = pendingFreqChange.oldFreq + ' MHz';
      document.getElementById('freq-new-value').textContent = pendingFreqChange.newFreq + ' MHz';
      document.getElementById('freq-modal-details').textContent = t('WARN_FREQ_CHANGE_DETAILS', pendingFreqChange.newFreq);
      document.getElementById('freq-confirm-text').textContent = t('WARN_FREQ_CHANGE_BTN');
      
      modal.classList.add('show');
    }
    
    document.getElementById('freq-cancel').addEventListener('click', () => {
      if (pendingFreqChange) {
        pendingFreqChange.inputEl.value = pendingFreqChange.oldFreq;
        pendingFreqChange = null;
      }
      document.getElementById('freq-modal').classList.remove('show');
    });
    
    document.getElementById('freq-confirm').addEventListener('click', () => {
      if (pendingFreqChange) {
        const stations = pendingFreqChange.type === 'fm' ? fmStations : dabStations;
        stations[pendingFreqChange.index].frequency = pendingFreqChange.newFreq;
        pendingFreqChange.inputEl.dataset.original = pendingFreqChange.newFreq;
        
        const duplicate = stations.find((s, i) => 
          i !== pendingFreqChange.index && s.frequency === pendingFreqChange.newFreq && !s.deleted
        );
        if (duplicate) {
          showToast(t('WARN_FREQ_DUPLICATE', pendingFreqChange.newFreq), 'warning');
        }
        
        markChanged();
        showToast(t('TOAST_FREQUENCY_CHANGED', pendingFreqChange.newFreq));
        pendingFreqChange = null;
      }
      document.getElementById('freq-modal').classList.remove('show');
    });
    
    // Update statistics
    function updateStats() {
      const fmFiltered = fmStations.filter(s => !s.deleted);
      const dabFiltered = dabStations.filter(s => !s.deleted);
      
      document.getElementById('fm-total').textContent = fmFiltered.length;
      document.getElementById('fm-favorites').textContent = fmFiltered.filter(s => s.favorite).length;
      document.getElementById('fm-hidden').textContent = fmFiltered.filter(s => s.hidden).length;
      
      document.getElementById('dab-total').textContent = dabFiltered.length;
      document.getElementById('dab-favorites').textContent = dabFiltered.filter(s => s.favorite).length;
      document.getElementById('dab-hidden').textContent = dabFiltered.filter(s => s.hidden).length;
    }
    
    // Update recycle count
    function updateRecycleCount() {
      const deletedCount = fmStations.filter(s => s.deleted).length + dabStations.filter(s => s.deleted).length;
      document.getElementById('recycle-count').textContent = deletedCount;
      document.getElementById('recycle-count').style.display = deletedCount > 0 ? 'inline-block' : 'none';
    }
    
    // Mark as changed
    function markChanged() {
      hasChanges = true;
      updateSaveStatus(t('STATUS_UNSAVED'), true);
      document.getElementById('save-btn').disabled = false;
    }
    
    // Mark a specific row as dirty
    function markRowDirty(type, idx) {
      const stations = type === 'fm' ? fmStations : dabStations;
      stations[idx].dirty = true;
      
      // Mark the station-item element as dirty
      const stationItem = document.querySelector(`.station-item[data-type="${type}"][data-index="${idx}"]`);
      if (stationItem) {
        stationItem.classList.add('dirty');
      }
      
      // Update global save status
      markChanged();
      updateDirtyCount();
    }
    
    // Update dirty count in save button text
    function updateDirtyCount() {
      const dirtyFm = fmStations.filter(s => s.dirty && !s.deleted).length;
      const dirtyDab = dabStations.filter(s => s.dirty && !s.deleted).length;
      const totalDirty = dirtyFm + dirtyDab;
      
      if (totalDirty > 0) {
        document.getElementById('btn-save-text').textContent = t('BTN_SAVE') + ' (' + totalDirty + ')';
        document.getElementById('btn-save-text-inline').textContent = t('BTN_SAVE') + ' (' + totalDirty + ')';
      } else {
        document.getElementById('btn-save-text').textContent = t('BTN_SAVE');
        document.getElementById('btn-save-text-inline').textContent = t('BTN_SAVE');
      }
    }
    
    // Save a specific row
    async function saveRow(type, idx) {
      const stations = type === 'fm' ? fmStations : dabStations;
      const station = stations[idx];
      
      if (!station.dirty) return;
      
      showToast(t('STATUS_SAVING') + '...', 'info');
      
      try {
        // Save stations to backend
        await saveChanges();
        
        // Mark row as clean
        station.dirty = false;
        
        // Remove dirty class from UI
        const stationItem = document.querySelector(`.station-item[data-type="${type}"][data-index="${idx}"]`);
        if (stationItem) {
          stationItem.classList.remove('dirty');
        }
        
        // Check if any other rows are dirty
        const dirtyFm = fmStations.filter(s => s.dirty && !s.deleted).length;
        const dirtyDab = dabStations.filter(s => s.dirty && !s.deleted).length;
        
        if (dirtyFm === 0 && dirtyDab === 0) {
          hasChanges = false;
          updateSaveStatus(t('STATUS_SAVED'), false);
        } else {
          updateDirtyCount();
        }
        
        showToast(t('TOAST_SAVED'), 'success', 1500);
      } catch (error) {
        showToast(t('TOAST_SAVE_FAILED', error.message), 'error');
      }
    }
    
    // Update save status
    function updateSaveStatus(message, changed) {
      // Update bottom save bar
      const statusEl = document.getElementById('save-status');
      const iconEl = statusEl.querySelector('.fa');
      const textEl = document.getElementById('status-text');
      
      textEl.textContent = message;
      
      if (changed) {
        statusEl.classList.add('changed');
        iconEl.className = 'fa fa-exclamation-triangle';
      } else {
        statusEl.classList.remove('changed');
        iconEl.className = 'fa fa-check-circle';
      }
      
      // Update inline save status
      const statusInlineEl = document.getElementById('save-status-inline');
      const iconInlineEl = statusInlineEl.querySelector('.fa');
      const textInlineEl = document.getElementById('status-text-inline');
      
      textInlineEl.textContent = message;
      
      if (changed) {
        statusInlineEl.classList.add('changed');
        iconInlineEl.className = 'fa fa-exclamation-triangle';
      } else {
        statusInlineEl.classList.remove('changed');
        iconInlineEl.className = 'fa fa-check-circle';
      }
      
      // Update both save buttons
      document.getElementById('save-btn').disabled = !changed;
      document.getElementById('save-btn-inline').disabled = !changed;
    }
    
    // Save changes
    async function saveChanges() {
      try {
        document.getElementById('save-btn').disabled = true;
        document.getElementById('save-btn-inline').disabled = true;
        updateSaveStatus(t('STATUS_SAVING'), false);
        
        // Clear all dirty flags before saving
        const cleanFm = fmStations.map(s => {
          const clean = {...s};
          delete clean.dirty;
          return clean;
        });
        const cleanDab = dabStations.map(s => {
          const clean = {...s};
          delete clean.dirty;
          return clean;
        });
        
        const response = await fetch('/api/stations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fm: cleanFm, dab: cleanDab })
        });
        
        if (!response.ok) throw new Error('Save failed');
        
        // Clean in-memory versions too
        fmStations.forEach(s => delete s.dirty);
        dabStations.forEach(s => delete s.dirty);
        
        // Remove dirty class from all rows
        document.querySelectorAll('.station-item.dirty').forEach(el => {
          el.classList.remove('dirty');
        });
        
        hasChanges = false;
        updateSaveStatus(t('STATUS_SAVED'), false);
        updateDirtyCount();
        showToast(t('TOAST_SAVED'));
        setTimeout(() => loadStations(), 1000);
        
      } catch (error) {
        showToast(t('TOAST_SAVE_FAILED', error.message), 'error');
        document.getElementById('save-btn').disabled = false;
        document.getElementById('save-btn-inline').disabled = false;
        updateSaveStatus(t('STATUS_UNSAVED'), true);
      }
    }
    
    // Clear all FM stations
    document.getElementById('clear-fm-btn').addEventListener('click', async () => {
      const count = fmStations.filter(s => !s.deleted).length;
      if (count === 0) {
        showToast(t('EMPTY_FM'), 'warning');
        return;
      }
      
      const confirmed = await showConfirmModal(
        t('CONFIRM_CLEAR_FM_TITLE'),
        t('CONFIRM_CLEAR_FM_MSG', count),
        'danger'
      );
      if (!confirmed) return;
      
      try {
        const response = await fetch('/api/stations/clear-fm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) throw new Error('Clear failed');
        
        const data = await response.json();
        showToast(t('TOAST_CLEARED_FM', data.count));
        setTimeout(() => loadStations(), 1000);
        
      } catch (error) {
        showToast(t('TOAST_CLEAR_FAILED', error.message), 'error');
      }
    });
    
    // Clear all DAB stations
    document.getElementById('clear-dab-btn').addEventListener('click', async () => {
      const count = dabStations.filter(s => !s.deleted).length;
      if (count === 0) {
        showToast(t('EMPTY_DAB'), 'warning');
        return;
      }
      
      const confirmed = await showConfirmModal(
        t('CONFIRM_CLEAR_DAB_TITLE'),
        t('CONFIRM_CLEAR_DAB_MSG', count),
        'danger'
      );
      if (!confirmed) return;
      
      try {
        const response = await fetch('/api/stations/clear-dab', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) throw new Error('Clear failed');
        
        const data = await response.json();
        showToast(t('TOAST_CLEARED_DAB', data.count));
        setTimeout(() => loadStations(), 1000);
        
      } catch (error) {
        showToast(t('TOAST_CLEAR_FAILED', error.message), 'error');
      }
    });
    
    // Rescan FM stations
    document.getElementById('rescan-fm-btn').addEventListener('click', async () => {
      const confirmed = await showConfirmModal(
        t('CONFIRM_RESCAN_FM_TITLE'),
        t('CONFIRM_RESCAN_FM'),
        'info'
      );
      if (!confirmed) return;
      
      try {
        showScanningModal('fm');
        
        const response = await fetch('/api/stations/scan-fm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) throw new Error('Rescan failed');
        
        showToast(t('TOAST_FM_SCANNING'));
        pollScanStatus('fm');
        
      } catch (error) {
        hideScanningModal();
        showToast(t('TOAST_RESCAN_FAILED', error.message), 'error');
      }
    });
    
    // Rescan DAB stations
    document.getElementById('rescan-dab-btn').addEventListener('click', async () => {
      const confirmed = await showConfirmModal(
        t('CONFIRM_RESCAN_DAB_TITLE'),
        t('CONFIRM_RESCAN_DAB'),
        'info'
      );
      if (!confirmed) return;
      
      try {
        showScanningModal('dab');
        
        const response = await fetch('/api/stations/scan-dab', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) throw new Error('Rescan failed');
        
        showToast(t('TOAST_DAB_SCANNING'));
        pollScanStatus('dab');
        
      } catch (error) {
        hideScanningModal();
        showToast(t('TOAST_RESCAN_FAILED', error.message), 'error');
      }
    });
    
    // Empty recycle bin
    document.getElementById('empty-recycle-btn').addEventListener('click', async () => {
      const deletedCount = fmStations.filter(s => s.deleted).length + dabStations.filter(s => s.deleted).length;
      
      if (deletedCount === 0) {
        showToast(t('EMPTY_RECYCLE'), 'warning');
        return;
      }
      
      const confirmed = await showConfirmModal(
        t('CONFIRM_EMPTY_RECYCLE_TITLE'),
        t('CONFIRM_EMPTY_RECYCLE_MSG', deletedCount),
        'danger'
      );
      if (!confirmed) return;
      
      try {
        const response = await fetch('/api/stations/purge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) throw new Error('Purge failed');
        
        showToast(t('TOAST_RECYCLE_EMPTIED', deletedCount), 'warning');
        setTimeout(() => loadStations(), 1000);
        
      } catch (error) {
        showToast(t('TOAST_WEB_RECYCLE_EMPTY_FAILED', error.message), 'error');
      }
    });
    
    // Show toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const iconEl = toast.querySelector('.fa');
      const messageEl = document.getElementById('toast-message');
      
      messageEl.textContent = message;
      
      if (type === 'error') {
        toast.className = 'toast show error';
        iconEl.className = 'fa fa-exclamation-triangle';
      } else if (type === 'warning') {
        toast.className = 'toast show warning';
        iconEl.className = 'fa fa-exclamation-circle';
      } else {
        toast.className = 'toast show';
        iconEl.className = 'fa fa-check-circle';
      }
      
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Search functionality
    document.getElementById('fm-search').addEventListener('input', () => renderStations('fm', fmStations));
    document.getElementById('dab-search').addEventListener('input', () => renderStations('dab', dabStations));
    document.getElementById('recycle-search').addEventListener('input', () => renderRecycleBin());
    
    // Save button
    document.getElementById('save-btn').addEventListener('click', saveChanges);
    document.getElementById('save-btn-inline').addEventListener('click', saveChanges);
    
    // Warn on unsaved changes
    window.addEventListener('beforeunload', (e) => {
      if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
    
    // Initialize
    loadTranslations().then(() => {
      loadStations();
      startSignalPolling();
    });
    
    // Maintenance Tab Functions
    function initMaintenanceTab() {
      loadBackupHistory();
      loadMaintenanceSettings();
      loadBlocklist();
      
      const uploadInput = document.getElementById('backup-upload');
      if (uploadInput) {
        uploadInput.addEventListener('change', function() {
          const filename = this.files[0] ? this.files[0].name : '';
          document.getElementById('upload-filename').textContent = filename;
          document.getElementById('upload-preview-btn').disabled = !this.files[0];
        });
      }
    }
    
    function loadMaintenanceSettings() {
      fetch('/api/maintenance/settings')
        .then(res => res.json())
        .then(data => {
          document.getElementById('auto-backup-checkbox').checked = data.autoBackup || false;
        })
        .catch(err => console.error('Failed to load settings:', err));
    }
    
    // Artwork Block List functions
    function loadBlocklist() {
      fetch('/api/blocklist')
        .then(res => res.json())
        .then(data => {
          var phrases = data.phrases || [];
          document.getElementById('blocklist-textarea').value = phrases.join('\n');
          updateBlocklistCount();
        })
        .catch(err => console.error('Failed to load blocklist:', err));
    }
    
    function updateBlocklistCount() {
      var textarea = document.getElementById('blocklist-textarea');
      var lines = textarea.value.split('\n').filter(function(line) {
        return line.trim().length > 0;
      });
      var count = lines.length;
      var label = count === 1 ? t('BLOCKLIST_COUNT_SINGLE') : t('BLOCKLIST_COUNT_PLURAL');
      document.getElementById('blocklist-count').textContent = count + ' ' + label;
    }
    
    function saveBlocklist() {
      var textarea = document.getElementById('blocklist-textarea');
      var lines = textarea.value.split('\n');
      var phrases = lines.map(function(line) {
        return line.trim();
      }).filter(function(line) {
        return line.length > 0;
      });
      
      // Warn if saving empty list
      if (phrases.length === 0) {
        showConfirmModal(
          t('BLOCKLIST_EMPTY_TITLE'),
          t('BLOCKLIST_EMPTY_MSG'),
          function() {
            doSaveBlocklist(phrases);
          }
        );
        return;
      }
      
      doSaveBlocklist(phrases);
    }
    
    function doSaveBlocklist(phrases) {
      fetch('/api/blocklist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phrases: phrases })
      })
      .then(res => res.json())
      .then(function() {
        showToast(t('TOAST_BLOCKLIST_SAVED'), 'success');
        updateBlocklistCount();
      })
      .catch(function(err) {
        showToast(t('TOAST_BLOCKLIST_SAVE_FAILED'), 'error');
      });
    }
    
    function resetBlocklist() {
      showConfirmModal(
        t('BLOCKLIST_RESET_TITLE'),
        t('BLOCKLIST_RESET_MSG'),
        function() {
          fetch('/api/blocklist/reset', { method: 'POST' })
            .then(res => res.json())
            .then(function(data) {
              var phrases = data.phrases || [];
              document.getElementById('blocklist-textarea').value = phrases.join('\n');
              updateBlocklistCount();
              showToast(t('TOAST_BLOCKLIST_RESET'), 'success');
            })
            .catch(function(err) {
              showToast(t('TOAST_BLOCKLIST_RESET_FAILED'), 'error');
            });
        }
      );
    }
    
    // Add event listener for blocklist textarea
    document.getElementById('blocklist-textarea').addEventListener('input', updateBlocklistCount);
    
    function saveMaintenanceSettings() {
      const autoBackup = document.getElementById('auto-backup-checkbox').checked;
      fetch('/api/maintenance/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ autoBackup })
      })
      .then(res => res.json())
      .then(() => showToast(t('TOAST_SAVED'), 'success'))
      .catch(err => showToast(t('TOAST_SAVE_FAILED', err.message), 'error'));
    }
    
    function createBackup() {
      const type = document.querySelector('input[name="backup-type"]:checked').value;
      showToast(t('TOAST_BACKUP_CREATING'), 'info');
      
      fetch('/api/maintenance/backup/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type })
      })
      .then(res => res.json())
      .then(() => {
        showToast(t('TOAST_BACKUP_CREATED'), 'success');
        loadBackupHistory();
      })
      .catch(err => showToast(t('TOAST_BACKUP_FAILED') + ': ' + err.message, 'error'));
    }
    
    function loadBackupHistory() {
      fetch('/api/maintenance/backup/list')
        .then(res => res.json())
        .then(data => {
          populateBackupHistory(data);
          populateRestoreSelects(data);
        })
        .catch(err => console.error('Failed to load backups:', err));
    }
    
    function populateBackupHistory(data) {
      const tbody = document.getElementById('backup-history-body');
      tbody.innerHTML = '';
      
      const allBackups = [];
      data.stations.forEach(b => { b.type = 'stations'; allBackups.push(b); });
      data.config.forEach(b => { b.type = 'config'; allBackups.push(b); });
      data.blocklist.forEach(b => { b.type = 'blocklist'; allBackups.push(b); });
      allBackups.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      allBackups.forEach(backup => {
        const row = document.createElement('tr');
        
        let typeText;
        if (backup.type === 'stations') {
          typeText = t('BACKUP_TYPE_STATIONS_SHORT');
        } else if (backup.type === 'config') {
          typeText = t('BACKUP_TYPE_CONFIG_SHORT');
        } else {
          typeText = t('BACKUP_TYPE_BLOCKLIST_SHORT');
        }
        
        const cells = [
          typeText,
          new Date(backup.date).toLocaleString(),
          formatBytes(backup.size),
          `<button class="btn btn-sm btn-secondary" onclick="downloadBackup('${backup.type}','${backup.timestamp}')"><i class="fa fa-download"></i></button>`,
          `<button class="btn btn-sm btn-danger" onclick="confirmDeleteBackup('${backup.type}','${backup.timestamp}')"><i class="fa fa-trash"></i></button>`
        ];
        
        cells.forEach(content => {
          const td = document.createElement('td');
          if (typeof content === 'string' && content.includes('<button')) {
            td.innerHTML = content;
          } else {
            td.textContent = content;
          }
          row.appendChild(td);
        });
        
        tbody.appendChild(row);
      });
    }
    
    function populateRestoreSelects(data) {
      const stationsSelect = document.getElementById('stations-restore-select');
      const configSelect = document.getElementById('config-restore-select');
      const blocklistSelect = document.getElementById('blocklist-restore-select');
      
      stationsSelect.innerHTML = '<option value="">' + t('OPTION_LATEST') + '</option>';
      configSelect.innerHTML = '<option value="">' + t('OPTION_LATEST') + '</option>';
      blocklistSelect.innerHTML = '<option value="">' + t('OPTION_LATEST') + '</option>';
      
      data.stations.forEach(backup => {
        const option = document.createElement('option');
        option.value = backup.timestamp;
        option.textContent = new Date(backup.date).toLocaleString();
        stationsSelect.appendChild(option);
      });
      
      data.config.forEach(backup => {
        const option = document.createElement('option');
        option.value = backup.timestamp;
        option.textContent = new Date(backup.date).toLocaleString();
        configSelect.appendChild(option);
      });
      
      data.blocklist.forEach(backup => {
        const option = document.createElement('option');
        option.value = backup.timestamp;
        option.textContent = new Date(backup.date).toLocaleString();
        blocklistSelect.appendChild(option);
      });
    }
    
    async function restoreSelected() {
      const stationsTimestamp = document.getElementById('stations-restore-select').value;
      const configTimestamp = document.getElementById('config-restore-select').value;
      const blocklistTimestamp = document.getElementById('blocklist-restore-select').value;
      
      if (!stationsTimestamp && !configTimestamp && !blocklistTimestamp) {
        showToast(t('TOAST_SELECT_BACKUP'), 'warning');
        return;
      }
      
      const confirmed = await showConfirmModal(
        t('MAINTENANCE_CONFIRM_RESTORE_TITLE'),
        t('MAINTENANCE_CONFIRM_RESTORE_MSG'),
        'warning'
      );
      if (!confirmed) return;
      
      showToast(t('TOAST_RESTORING'), 'info');
      
      fetch('/api/maintenance/backup/restore', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stationsTimestamp, configTimestamp, blocklistTimestamp })
      })
      .then(res => res.json())
      .then(() => showToast(t('TOAST_RESTORE_SUCCESS'), 'success'))
      .catch(err => showToast(t('TOAST_RESTORE_FAILED_MSG') + ': ' + err.message, 'error'));
    }
    
    function restoreLatestFull() {
      const stationsSelect = document.getElementById('stations-restore-select');
      const configSelect = document.getElementById('config-restore-select');
      const blocklistSelect = document.getElementById('blocklist-restore-select');
      
      if (stationsSelect.options.length > 1) stationsSelect.selectedIndex = 1;
      if (configSelect.options.length > 1) configSelect.selectedIndex = 1;
      if (blocklistSelect.options.length > 1) blocklistSelect.selectedIndex = 1;
      
      restoreSelected();
    }
    
    function downloadBackup(type, timestamp) {
      window.location.href = `/api/maintenance/backup/download?type=${type}&timestamp=${timestamp}`;
    }
    
    async function confirmDeleteBackup(type, timestamp) {
      const confirmed = await showConfirmModal(
        t('MAINTENANCE_CONFIRM_DELETE_TITLE'),
        t('MAINTENANCE_CONFIRM_DELETE_MSG'),
        'danger'
      );
      if (!confirmed) return;
      
      fetch('/api/maintenance/backup/delete', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type, timestamp })
      })
      .then(res => res.json())
      .then(() => {
        showToast(t('TOAST_BACKUP_DELETED'), 'success');
        loadBackupHistory();
      })
      .catch(err => showToast(t('TOAST_DELETE_FAILED') + ': ' + err.message, 'error'));
    }
    
    async function uploadAndPreview() {
      const fileInput = document.getElementById('backup-upload');
      if (!fileInput.files[0]) return;
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      showToast(t('TOAST_VALIDATING'), 'info');
      
      try {
        const res = await fetch('/api/maintenance/backup/upload', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        
        if (data.success) {
          let msg = data.info.type === 'stations' 
            ? t('UPLOAD_PREVIEW_STATIONS_MSG', data.info.fmCount, data.info.dabCount)
            : t('UPLOAD_PREVIEW_CONFIG_MSG');
          
          const confirmed = await showConfirmModal(
            t('MAINTENANCE_CONFIRM_UPLOAD_RESTORE_TITLE'),
            msg + '\n\n' + t('MAINTENANCE_CONFIRM_UPLOAD_RESTORE_MSG'),
            'info'
          );
          
          if (confirmed) {
            uploadAndRestore();
          }
        } else {
          showToast(t('TOAST_INVALID_BACKUP'), 'error');
        }
      } catch (err) {
        showToast(t('TOAST_UPLOAD_FAILED') + ': ' + err.message, 'error');
      }
    }
    
    function uploadAndRestore() {
      const fileInput = document.getElementById('backup-upload');
      if (!fileInput.files[0]) return;
      
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      showToast(t('TOAST_RESTORING'), 'info');
      
      fetch('/api/maintenance/backup/upload-restore', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(() => showToast(t('TOAST_RESTORE_SUCCESS'), 'success'))
      .catch(err => showToast(t('TOAST_RESTORE_FAILED_MSG') + ': ' + err.message, 'error'));
    }
    
    // ========== CSV IMPORT/EXPORT FUNCTIONS ==========
    
    function downloadCsvTemplate(type) {
      window.location.href = '/api/csv/template/' + type;
    }
    
    function exportCsv(type) {
      window.location.href = '/api/csv/export/' + type;
    }
    
    function csvFileSelected() {
      var fileInput = document.getElementById('csv-file-input');
      var filenameSpan = document.getElementById('csv-filename');
      var validateBtn = document.getElementById('btn-csv-validate');
      var importBtn = document.getElementById('btn-csv-import');
      
      if (fileInput.files.length > 0) {
        filenameSpan.textContent = fileInput.files[0].name;
        filenameSpan.style.color = '#e0e0e0';
        validateBtn.disabled = false;
        importBtn.disabled = true;  // Require validation first
        hideCsvValidationResults();
      } else {
        filenameSpan.textContent = t('CSV_NO_FILE');
        filenameSpan.style.color = '#888';
        validateBtn.disabled = true;
        importBtn.disabled = true;
      }
    }
    
    async function validateCsv() {
      var fileInput = document.getElementById('csv-file-input');
      if (!fileInput.files.length) {
        showToast(t('CSV_NO_FILE_SELECTED'), 'warning');
        return;
      }
      
      var formData = new FormData();
      formData.append('file', fileInput.files[0]);
      
      try {
        var response = await fetch('/api/csv/validate', {
          method: 'POST',
          body: formData
        });
        
        var result = await response.json();
        
        if (response.ok) {
          displayCsvValidationResults(result);
          
          // Enable import button only if validation passed
          document.getElementById('btn-csv-import').disabled = !result.valid;
        } else {
          showCsvValidationError(result.error || 'Validation failed');
        }
      } catch (error) {
        showCsvValidationError(error.message);
      }
    }
    
    function displayCsvValidationResults(result) {
      var box = document.getElementById('csv-validation-results');
      var content = document.getElementById('csv-validation-content');
      
      var html = '<p><strong>' + t('CSV_VALIDATION_FILE') + ':</strong> ' + escapeCsvHtml(result.filename) + '</p>';
      html += '<p><strong>' + t('CSV_VALIDATION_TYPE') + ':</strong> ' + result.type.toUpperCase() + '</p>';
      html += '<p><strong>' + t('CSV_VALIDATION_VALID') + ':</strong> ' + result.validCount + ' / ' + result.totalRows + '</p>';
      
      if (result.errors.length > 0) {
        html += '<p><strong>' + t('CSV_VALIDATION_ERRORS') + ':</strong> ' + result.errors.length + '</p>';
        html += '<ul class="csv-error-list">';
        result.errors.forEach(function(err) {
          html += '<li>Row ' + err.line + ': ' + escapeCsvHtml(err.message) + '</li>';
        });
        html += '</ul>';
        box.classList.add('has-errors');
        box.classList.remove('valid');
      } else {
        html += '<p style="color: #54b948;">' + t('CSV_VALIDATION_PASSED') + '</p>';
        box.classList.remove('has-errors');
        box.classList.add('valid');
      }
      
      content.innerHTML = html;
      box.classList.add('visible');
    }
    
    function showCsvValidationError(message) {
      var box = document.getElementById('csv-validation-results');
      var content = document.getElementById('csv-validation-content');
      
      content.innerHTML = '<p style="color: #e74c3c;">' + escapeCsvHtml(message) + '</p>';
      box.classList.add('visible', 'has-errors');
      box.classList.remove('valid');
    }
    
    function hideCsvValidationResults() {
      var box = document.getElementById('csv-validation-results');
      box.classList.remove('visible', 'has-errors', 'valid');
    }
    
    async function importCsv() {
      var fileInput = document.getElementById('csv-file-input');
      if (!fileInput.files.length) {
        showToast(t('CSV_NO_FILE_SELECTED'), 'warning');
        return;
      }
      
      var operation = document.querySelector('input[name="csv-operation"]:checked').value;
      
      // Confirm destructive operations
      if (operation === 'replace') {
        var confirmed = await showConfirmModal(
          t('CSV_CONFIRM_REPLACE'),
          t('CSV_OP_REPLACE_DESC'),
          'warning'
        );
        if (!confirmed) return;
      } else if (operation === 'remove') {
        var confirmed = await showConfirmModal(
          t('CSV_CONFIRM_REMOVE'),
          t('CSV_OP_REMOVE_DESC'),
          'warning'
        );
        if (!confirmed) return;
      }
      
      var formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('operation', operation);
      
      try {
        var response = await fetch('/api/csv/import', {
          method: 'POST',
          body: formData
        });
        
        var result = await response.json();
        
        if (result.success) {
          var msg = t('CSV_IMPORT_SUCCESS') + ': ';
          var parts = [];
          if (result.imported > 0) parts.push(result.imported + ' imported');
          if (result.updated > 0) parts.push(result.updated + ' updated');
          if (result.removed > 0) parts.push(result.removed + ' removed');
          if (result.skipped > 0) parts.push(result.skipped + ' skipped');
          msg += parts.join(', ');
          
          showToast(msg, 'success');
          loadStations();  // Refresh station list
          
          // Reset file input
          fileInput.value = '';
          csvFileSelected();
        } else {
          showToast(t('CSV_IMPORT_FAILED') + ': ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showToast(t('CSV_IMPORT_FAILED') + ': ' + error.message, 'error');
      }
    }
    
    function escapeCsvHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Signal quality polling
    function startSignalPolling() {
      // Clear any existing interval
      if (signalPollInterval) {
        clearInterval(signalPollInterval);
      }
      
      // Poll every 2 seconds
      signalPollInterval = setInterval(pollSignal, 2000);
      // Initial poll
      pollSignal();
    }
    
    function pollSignal() {
      fetch('/api/status')
        .then(res => res.json())
        .then(data => {
          const oldSignal = currentSignal;
          currentSignal = data.signal;
          
          // Check if signal state changed
          const oldKey = oldSignal ? `${oldSignal.type}-${oldSignal.level}-${oldSignal.frequency || ''}-${oldSignal.station?.exactName || ''}` : '';
          const newKey = currentSignal ? `${currentSignal.type}-${currentSignal.level}-${currentSignal.frequency || ''}-${currentSignal.station?.exactName || ''}` : '';
          
          if (oldKey !== newKey) {
            // Signal changed, re-render affected station lists
            if (currentSignal?.type === 'fm' || oldSignal?.type === 'fm') {
              renderStations('fm', fmStations);
            }
            if (currentSignal?.type === 'dab' || oldSignal?.type === 'dab') {
              renderStations('dab', dabStations);
            }
          }
        })
        .catch(() => {
          // Ignore polling errors silently
        });
    }
    
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Initialize maintenance tab when clicked
    document.addEventListener('DOMContentLoaded', function() {
      const maintenanceTab = document.querySelector('[data-tab="maintenance"]');
      if (maintenanceTab) {
        maintenanceTab.addEventListener('click', function() {
          initMaintenanceTab();
        }, { once: true });
      }
      
      // Initialize blocklist tab when clicked
      const blocklistTab = document.querySelector('[data-tab="blocklist"]');
      if (blocklistTab) {
        blocklistTab.addEventListener('click', function() {
          loadBlocklist();
        }, { once: true });
      }
    });
    
    // Touchscreen keyboard support for iframe context
    // When running in iframe, notify parent window about input focus for onscreen keyboard
    if (window.parent !== window) {
      // Running in iframe - setup focus/blur event delegation
      let hideKeyboardTimeout = null;
      let currentFocusedInput = null;
      let keyboardRelayMode = false; // Track if keyboard is in relay mode
      
      // Add CSS to maintain focus appearance
      const style = document.createElement('style');
      style.textContent = '.volumio-keyboard-focused { outline: 2px solid #4CAF50 !important; outline-offset: -2px !important; }';
      document.head.appendChild(style);
      
      document.addEventListener('focusin', (e) => {
        if (e.target.matches('input, textarea')) {
          // Track currently focused input
          currentFocusedInput = e.target;
          keyboardRelayMode = true; // Entering keyboard relay mode
          
          // Add visual focus class
          e.target.classList.add('volumio-keyboard-focused');
          
          // Cancel any pending hide operation
          if (hideKeyboardTimeout) {
            clearTimeout(hideKeyboardTimeout);
            hideKeyboardTimeout = null;
          }
          
          // Notify parent window that an input was focused
          window.parent.postMessage({
            type: 'volumio-input-focus',
            action: 'show-keyboard'
          }, '*');
        }
      }, true);
      
      document.addEventListener('focusout', (e) => {
        if (e.target.matches('input, textarea')) {
          // Don't schedule hide if we're in keyboard relay mode
          // The keyboard should stay visible even though input lost real focus
          if (!keyboardRelayMode) {
            // Normal hide logic for when keyboard not in relay mode
            hideKeyboardTimeout = setTimeout(() => {
              currentFocusedInput = null;
              e.target.classList.remove('volumio-keyboard-focused');
              
              window.parent.postMessage({
                type: 'volumio-input-focus',
                action: 'hide-keyboard'
              }, '*');
              hideKeyboardTimeout = null;
            }, 300);
          }
          // If in relay mode, do nothing - keyboard stays visible
        }
      }, true);
      
      // Listen for explicit close requests (user clicks outside, etc)
      document.addEventListener('click', (e) => {
        if (keyboardRelayMode && !e.target.matches('input, textarea')) {
          // User clicked outside input while keyboard active - close it
          keyboardRelayMode = false;
          
          if (currentFocusedInput) {
            currentFocusedInput.classList.remove('volumio-keyboard-focused');
            currentFocusedInput = null;
          }
          
          window.parent.postMessage({
            type: 'volumio-input-focus',
            action: 'hide-keyboard'
          }, '*');
        }
      }, true);
      
      // Listen for keystroke events from parent (keyboard input relay)
      window.addEventListener('message', (e) => {
        if (e.data && e.data.type === 'volumio-keystroke' && e.data.action === 'input') {
          // Apply keystroke to currently tracked input
          if (currentFocusedInput) {
            const input = currentFocusedInput;
            const cursorPos = input.selectionStart || 0;
            const currentValue = input.value || '';
            const newChar = e.data.value;
            
            // Insert character at cursor position
            const newValue = currentValue.substring(0, cursorPos) + newChar + currentValue.substring(cursorPos);
            input.value = newValue;
            
            // Move cursor forward
            const newCursorPos = cursorPos + newChar.length;
            input.setSelectionRange(newCursorPos, newCursorPos);
            
            // Trigger input event for any listeners
            input.dispatchEvent(new Event('input', { bubbles: true }));
            
            // Maintain visual focus
            if (!input.classList.contains('volumio-keyboard-focused')) {
              input.classList.add('volumio-keyboard-focused');
            }
          }
        }
      }, false);
    }
  
  // Antenna alignment - RF spectrum scan
  function scanSpectrum() {
    const statusEl = document.getElementById('spectrum-status');
    const canvasEl = document.getElementById('spectrum-chart');
    const btn = document.querySelector('button[onclick="scanSpectrum()"]');
    
    // Disable button during scan
    if (btn) btn.disabled = true;
    
    canvasEl.classList.remove('visible');
    
    const startTime = Date.now();
    
    function updateProgress() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      statusEl.textContent = t('SCANNING_FREQUENCIES') + '... ' + elapsed + 's';
      statusEl.style.color = '#f39c12';
    }
    
    updateProgress();
    const progressInterval = setInterval(updateProgress, 1000);
    
    fetch('/api/antenna/spectrum-scan', {
      method: 'POST'
    })
    .then(res => res.json())
    .then(data => {
      clearInterval(progressInterval);
      if (btn) btn.disabled = false;
      
      if (data.success) {
        drawSpectrumChart(data.spectrum);
        canvasEl.classList.add('visible');
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const timestamp = new Date(data.timestamp).toLocaleTimeString();
        statusEl.textContent = t('LAST_SCAN') + ': ' + timestamp + ' (' + elapsed + 's)';
        statusEl.style.color = '#54b948';
        showToast(t('SPECTRUM_SCAN_COMPLETE') + ' (' + elapsed + 's)', 'success');
      } else {
        statusEl.textContent = t('SCAN_FAILED');
        statusEl.style.color = '#e74c3c';
        showToast(t('SCAN_FAILED') + ': ' + (data.error || 'Unknown error'), 'error');
      }
    })
    .catch(err => {
      clearInterval(progressInterval);
      if (btn) btn.disabled = false;
      statusEl.textContent = t('SCAN_FAILED');
      statusEl.style.color = '#e74c3c';
      showToast(t('SCAN_FAILED') + ': ' + err.toString(), 'error');
    });
  }
  
  function drawSpectrumChart(spectrum) {
    const canvas = document.getElementById('spectrum-chart');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    const padding = 50;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2;
    
    // Clear canvas
    ctx.fillStyle = '#1c1c1c';
    ctx.fillRect(0, 0, width, height);
    
    if (!spectrum || spectrum.length === 0) return;
    
    // Find min/max power for scaling
    let minPower = Math.min(...spectrum.map(s => s.power));
    let maxPower = Math.max(...spectrum.map(s => s.power));
    const powerRange = maxPower - minPower;
    
    // Draw grid
    ctx.strokeStyle = '#404040';
    ctx.lineWidth = 1;
    for (let i = 0; i <= 5; i++) {
      const y = padding + (chartHeight / 5) * i;
      ctx.beginPath();
      ctx.moveTo(padding, y);
      ctx.lineTo(padding + chartWidth, y);
      ctx.stroke();
    }
    
    // Draw axes
    ctx.strokeStyle = '#666';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, padding + chartHeight);
    ctx.lineTo(padding + chartWidth, padding + chartHeight);
    ctx.stroke();
    
    // Draw DAB channel markers
    const dabChannels = [
      { name: '5A', freq: 174.9 },
      { name: '6A', freq: 181.9 },
      { name: '7A', freq: 188.9 },
      { name: '8A', freq: 195.9 },
      { name: '9A', freq: 202.9 },
      { name: '10A', freq: 209.9 },
      { name: '11A', freq: 216.9 },
      { name: '12A', freq: 223.9 },
      { name: '13A', freq: 230.7 }
    ];
    
    const freqMin = 174;
    const freqMax = 240;
    const freqRange = freqMax - freqMin;
    
    ctx.strokeStyle = '#666';
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 3]);
    ctx.fillStyle = '#999';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    
    dabChannels.forEach(channel => {
      const xPos = padding + ((channel.freq - freqMin) / freqRange) * chartWidth;
      
      // Draw vertical line
      ctx.beginPath();
      ctx.moveTo(xPos, padding);
      ctx.lineTo(xPos, padding + chartHeight);
      ctx.stroke();
      
      // Draw channel label at top
      ctx.fillText(channel.name, xPos, padding - 5);
    });
    
    ctx.setLineDash([]);
    
    // Draw spectrum bars
    const barWidth = chartWidth / spectrum.length;
    spectrum.forEach((point, i) => {
      const barHeight = ((point.power - minPower) / powerRange) * chartHeight;
      const x = padding + i * barWidth;
      const y = padding + chartHeight - barHeight;
      
      // Color based on power level
      const normalizedPower = (point.power - minPower) / powerRange;
      if (normalizedPower > 0.7) {
        ctx.fillStyle = '#54b948';
      } else if (normalizedPower > 0.4) {
        ctx.fillStyle = '#f39c12';
      } else {
        ctx.fillStyle = '#e74c3c';
      }
      
      ctx.fillRect(x, y, barWidth - 1, barHeight);
    });
    
    // Draw labels
    ctx.fillStyle = '#ccc';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    
    // X-axis labels (frequency)
    ctx.fillText('174 MHz', padding, padding + chartHeight + 20);
    ctx.fillText('207 MHz', padding + chartWidth / 2, padding + chartHeight + 20);
    ctx.fillText('240 MHz', padding + chartWidth, padding + chartHeight + 20);
    
    // Y-axis labels (power)
    ctx.textAlign = 'right';
    ctx.fillText(maxPower.toFixed(0) + ' dB', padding - 5, padding + 5);
    ctx.fillText(minPower.toFixed(0) + ' dB', padding - 5, padding + chartHeight + 5);
    
    // Title
    ctx.textAlign = 'center';
    ctx.fillStyle = '#fff';
    ctx.font = '14px sans-serif';
    ctx.fillText(t('DAB_BAND_SPECTRUM'), width / 2, 20);
  }
  
  function validateChannels() {
    const checkboxes = document.querySelectorAll('.channel-checkbox:checked');
    const channels = Array.from(checkboxes).map(cb => cb.value);
    
    if (channels.length === 0) {
      showToast(t('SELECT_CHANNELS'), 'warning');
      return;
    }
    
    const statusEl = document.getElementById('validation-status');
    const resultsEl = document.getElementById('channel-results');
    const btn = document.querySelector('button[onclick="validateChannels()"]');
    
    // Disable button during validation
    if (btn) btn.disabled = true;
    
    resultsEl.innerHTML = '';
    resultsEl.classList.remove('visible');
    
    // Progress tracking
    const startTime = Date.now();
    let completedChannels = 0;
    let eventSource = null;
    
    // Show initial status
    statusEl.textContent = t('VALIDATING') + ' (0/' + channels.length + ')... 0s';
    statusEl.style.color = '#f39c12';
    
    // Update elapsed time every second
    const timerInterval = setInterval(function() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      statusEl.textContent = t('VALIDATING') + ' (' + completedChannels + '/' + channels.length + ')... ' + elapsed + 's';
    }, 1000);
    
    // Use fetch to send POST data, then switch to EventSource
    fetch('/api/antenna/validate-dab', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ channels: channels })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('HTTP ' + response.status);
      }
      
      // Read the response as a stream
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      
      function processChunk() {
        reader.read().then(({ done, value }) => {
          if (done) {
            clearInterval(timerInterval);
            if (btn) btn.disabled = false;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            statusEl.textContent = t('LAST_CHECK') + ': ' + new Date().toLocaleTimeString() + ' (' + elapsed + 's)';
            statusEl.style.color = '#54b948';
            showToast(t('VALIDATION_COMPLETE') + ' (' + elapsed + 's)', 'success');
            return;
          }
          
          // Decode the chunk and add to buffer
          buffer += decoder.decode(value, { stream: true });
          
          // Process complete SSE messages
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete line in buffer
          
          lines.forEach(line => {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.substring(6));
                
                if (data.status === 'started') {
                  // Initial message
                  resultsEl.classList.add('visible');
                } else if (data.status === 'complete') {
                  // All done - handled by done above
                } else if (data.channel) {
                  // Channel result received
                  completedChannels = data.progress || (completedChannels + 1);
                  displayChannelResult(data);
                  
                  const elapsed = Math.floor((Date.now() - startTime) / 1000);
                  statusEl.textContent = t('VALIDATING') + ' (' + completedChannels + '/' + data.total + ')... ' + elapsed + 's';
                }
              } catch (e) {
                console.error('Failed to parse SSE data:', e);
              }
            }
          });
          
          // Continue reading
          processChunk();
        }).catch(err => {
          clearInterval(timerInterval);
          if (btn) btn.disabled = false;
          statusEl.textContent = t('VALIDATION_FAILED');
          statusEl.style.color = '#e74c3c';
          showToast(t('VALIDATION_FAILED') + ': ' + err.toString(), 'error');
        });
      }
      
      processChunk();
    })
    .catch(err => {
      clearInterval(timerInterval);
      if (btn) btn.disabled = false;
      statusEl.textContent = t('VALIDATION_FAILED');
      statusEl.style.color = '#e74c3c';
      showToast(t('VALIDATION_FAILED') + ': ' + err.toString(), 'error');
    });
  }
  
  function displayChannelResult(result) {
    const resultsEl = document.getElementById('channel-results');
    
    const qualityText = {
      'excellent': t('CHANNEL_EXCELLENT'),
      'strong': t('CHANNEL_STRONG'),
      'good': t('CHANNEL_GOOD'),
      'weak': t('CHANNEL_WEAK'),
      'poor': t('CHANNEL_POOR'),
      'none': t('CHANNEL_NONE'),
      'error': t('CHANNEL_ERROR')
    };
    
    const quality = result.quality || 'none';
    const text = qualityText[quality] || quality;
    const services = result.services > 0 ? ' (' + result.services + ' ' + t('SERVICES') + ')' : '';
    
    const div = document.createElement('div');
    div.className = 'channel-result';
    div.dataset.channel = result.channel;
    
    div.innerHTML = `
      <span class="channel-result-name">${result.channel}</span>
      <div class="channel-result-bar">
        <div class="channel-result-fill ${quality}"></div>
      </div>
      <span class="channel-result-text">${text}${services}</span>
    `;
    
    // Insert in order (channels might arrive out of order)
    const existingResults = Array.from(resultsEl.children);
    let inserted = false;
    
    for (let i = 0; i < existingResults.length; i++) {
      const existingChannel = existingResults[i].dataset.channel;
      if (result.channel < existingChannel) {
        resultsEl.insertBefore(div, existingResults[i]);
        inserted = true;
        break;
      }
    }
    
    if (!inserted) {
      resultsEl.appendChild(div);
    }
  }
  
  function displayChannelResults(results) {
    const resultsEl = document.getElementById('channel-results');
    resultsEl.innerHTML = '';
    
    const qualityText = {
      'excellent': t('CHANNEL_EXCELLENT'),
      'strong': t('CHANNEL_STRONG'),
      'good': t('CHANNEL_GOOD'),
      'weak': t('CHANNEL_WEAK'),
      'poor': t('CHANNEL_POOR'),
      'none': t('CHANNEL_NONE'),
      'error': t('CHANNEL_ERROR')
    };
    
    Object.keys(results).sort().forEach(channel => {
      const result = results[channel];
      const div = document.createElement('div');
      div.className = 'channel-result';
      
      const quality = result.quality || 'none';
      const text = qualityText[quality] || quality;
      const services = result.services > 0 ? ' (' + result.services + ' ' + t('SERVICES') + ')' : '';
      
      div.innerHTML = `
        <span class="channel-result-name">${channel}</span>
        <div class="channel-result-bar">
          <div class="channel-result-fill ${quality}"></div>
        </div>
        <span class="channel-result-text">${text}${services}</span>
      `;
      
      resultsEl.appendChild(div);
    });
  }
  
  // ===== SNR MEASUREMENT TOOL FUNCTIONS =====
  
  // Store validated channels for SNR tool
  var validatedChannels = [];
  var snrMeasurements = [];
  
  function updateSnrChannelSource() {
    const source = document.getElementById('snr-channel-source').value;
    const manualGrid = document.getElementById('snr-manual-channels');
    
    if (source === 'manual') {
      manualGrid.style.display = 'grid';
    } else {
      manualGrid.style.display = 'none';
    }
  }
  
  function getSnrChannels() {
    const source = document.getElementById('snr-channel-source').value;
    
    if (source === 'manual') {
      const checkboxes = document.querySelectorAll('.snr-channel-checkbox:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    } else if (source === 'validated') {
      // Get channels from validation results
      const resultsEl = document.getElementById('channel-results');
      const results = resultsEl.querySelectorAll('.channel-result');
      const channels = [];
      results.forEach(r => {
        const name = r.querySelector('.channel-result-name');
        const fill = r.querySelector('.channel-result-fill');
        // Only include channels that were detected (not 'none' or 'error')
        if (name && fill && !fill.classList.contains('none') && !fill.classList.contains('error')) {
          channels.push(name.textContent);
        }
      });
      return channels;
    } else {
      // Use scanned stations - get unique channels from DAB stations
      return getScannedDabChannels();
    }
  }
  
  function getScannedDabChannels() {
    // Extract unique channels from loaded DAB stations
    const channels = new Set();
    if (typeof dabStations !== 'undefined' && dabStations.length > 0) {
      dabStations.forEach(s => {
        if (s.channel && !s.deleted) {
          channels.add(s.channel.toUpperCase());
        }
      });
    }
    return Array.from(channels).sort();
  }
  
  function runSnrScan() {
    const channels = getSnrChannels();
    
    if (channels.length === 0) {
      const source = document.getElementById('snr-channel-source').value;
      if (source === 'scanned') {
        showToast(t('SNR_NO_SCANNED_CHANNELS') || 'No scanned DAB channels found. Run a DAB scan first.', 'warning');
      } else if (source === 'validated') {
        showToast(t('SNR_NO_VALIDATED_CHANNELS') || 'No validated channels found. Run Channel Validation (Tool 2) first.', 'warning');
      } else {
        showToast(t('SELECT_CHANNELS') || 'Please select channels', 'warning');
      }
      return;
    }
    
    const gainStart = parseInt(document.getElementById('snr-gain-start').value, 10);
    const gainStop = parseInt(document.getElementById('snr-gain-stop').value, 10);
    const gainStep = parseInt(document.getElementById('snr-gain-step').value, 10);
    
    if (gainStart > gainStop) {
      showToast(t('SNR_INVALID_RANGE') || 'Invalid gain range', 'warning');
      return;
    }
    
    const statusEl = document.getElementById('snr-status');
    const resultsEl = document.getElementById('snr-results');
    const btn = document.querySelector('button[onclick="runSnrScan()"]');
    
    if (btn) btn.disabled = true;
    resultsEl.style.display = 'none';
    snrMeasurements = [];
    
    const totalSteps = Math.floor((gainStop - gainStart) / gainStep) + 1;
    const startTime = Date.now();
    let currentStep = 0;
    
    statusEl.textContent = t('SNR_SCANNING') || 'Measuring SNR... (0/' + totalSteps + ')';
    statusEl.style.color = '#f39c12';
    
    const timerInterval = setInterval(function() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      statusEl.textContent = (t('SNR_SCANNING') || 'Measuring SNR...') + ' (' + currentStep + '/' + totalSteps + ') ' + elapsed + 's';
    }, 1000);
    
    fetch('/api/antenna/snr-scan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        channels: channels,
        gainStart: gainStart,
        gainStop: gainStop,
        gainStep: gainStep,
        integration: 2
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('HTTP ' + response.status);
      }
      
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      
      function processChunk() {
        reader.read().then(({ done, value }) => {
          if (done) {
            clearInterval(timerInterval);
            if (btn) btn.disabled = false;
            return;
          }
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          
          lines.forEach(line => {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.substring(6));
                
                if (data.status === 'started') {
                  // Initial message
                } else if (data.status === 'progress') {
                  currentStep = data.progress;
                  // Collect measurements
                  if (data.results) {
                    data.results.forEach(r => snrMeasurements.push(r));
                  }
                } else if (data.status === 'complete') {
                  clearInterval(timerInterval);
                  if (btn) btn.disabled = false;
                  
                  const elapsed = Math.floor((Date.now() - startTime) / 1000);
                  statusEl.textContent = (t('SNR_COMPLETE') || 'SNR measurement complete') + ' (' + elapsed + 's)';
                  statusEl.style.color = '#54b948';
                  
                  displaySnrResults(data);
                  showToast((t('SNR_COMPLETE') || 'SNR measurement complete') + ' (' + elapsed + 's)', 'success');
                } else if (data.status === 'error') {
                  clearInterval(timerInterval);
                  if (btn) btn.disabled = false;
                  statusEl.textContent = t('SNR_FAILED') || 'SNR measurement failed';
                  statusEl.style.color = '#e74c3c';
                  showToast((t('SNR_FAILED') || 'SNR measurement failed') + ': ' + data.error, 'error');
                }
              } catch (e) {
                console.error('Failed to parse SNR SSE data:', e);
              }
            }
          });
          
          processChunk();
        }).catch(err => {
          clearInterval(timerInterval);
          if (btn) btn.disabled = false;
          statusEl.textContent = t('SNR_FAILED') || 'SNR measurement failed';
          statusEl.style.color = '#e74c3c';
          showToast((t('SNR_FAILED') || 'SNR measurement failed') + ': ' + err.toString(), 'error');
        });
      }
      
      processChunk();
    })
    .catch(err => {
      clearInterval(timerInterval);
      if (btn) btn.disabled = false;
      statusEl.textContent = t('SNR_FAILED') || 'SNR measurement failed';
      statusEl.style.color = '#e74c3c';
      showToast((t('SNR_FAILED') || 'SNR measurement failed') + ': ' + err.toString(), 'error');
    });
  }
  
  function displaySnrResults(data) {
    const resultsEl = document.getElementById('snr-results');
    const bestGainEl = document.getElementById('snr-best-gain');
    const summaryBody = document.getElementById('snr-summary-body');
    const detailsBody = document.getElementById('snr-details-body');
    
    resultsEl.style.display = 'block';
    
    // Display best gain recommendation
    if (data.summary && data.summary.bestGain !== undefined) {
      bestGainEl.innerHTML = (t('SNR_BEST_GAIN') || 'Recommended Gain') + ': <strong>' + data.summary.bestGain + '</strong> ' +
                            '(' + (t('SNR_AVG') || 'Avg SNR') + ': ' + data.summary.bestAvgSnr + ' dB)';
    }
    
    // Display summary table
    summaryBody.innerHTML = '';
    if (data.summary && data.summary.byGain) {
      data.summary.byGain.forEach(g => {
        const tr = document.createElement('tr');
        if (g.gain === data.summary.bestGain) {
          tr.className = 'best-row';
        }
        tr.innerHTML = '<td>' + g.gain + '</td>' +
                      '<td>' + g.minSnr.toFixed(2) + '</td>' +
                      '<td>' + g.maxSnr.toFixed(2) + '</td>' +
                      '<td>' + g.avgSnr.toFixed(2) + '</td>';
        summaryBody.appendChild(tr);
      });
    }
    
    // Display detailed measurements
    detailsBody.innerHTML = '';
    if (data.measurements) {
      // Sort by gain, then channel
      const sorted = data.measurements.slice().sort((a, b) => {
        if (a.gain !== b.gain) return a.gain - b.gain;
        return a.channel.localeCompare(b.channel);
      });
      
      sorted.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + m.gain + '</td>' +
                      '<td>' + m.channel + '</td>' +
                      '<td>' + m.peak.toFixed(2) + '</td>' +
                      '<td>' + m.noise.toFixed(2) + '</td>' +
                      '<td>' + m.snr.toFixed(2) + '</td>';
        detailsBody.appendChild(tr);
      });
    }
    
    // Hide details by default
    document.getElementById('snr-details').style.display = 'none';
  }
  
  function toggleSnrDetails() {
    const details = document.getElementById('snr-details');
    const btn = document.querySelector('button[onclick="toggleSnrDetails()"]');
    
    if (details.style.display === 'none') {
      details.style.display = 'block';
      if (btn) btn.innerHTML = '<i class="fa fa-list"></i> ' + (t('SNR_HIDE_DETAILS') || 'Hide Details');
    } else {
      details.style.display = 'none';
      if (btn) btn.innerHTML = '<i class="fa fa-list"></i> ' + (t('SNR_SHOW_DETAILS') || 'Show Details');
    }
  }
  </script>
</body>
</html>
